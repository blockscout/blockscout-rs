use bytes::Bytes;

#[derive(Clone, Debug, PartialEq, Eq, PartialOrd, Ord)]
pub struct BlueprintContract {
    pub version: u8,
    pub preamble_data: Option<Bytes>,
    pub initcode: Bytes,
}

// https://eips.ethereum.org/EIPS/eip-5202#reference-implementation

pub fn from_runtime_code(code: Bytes) -> Option<BlueprintContract> {
    let prefix = [0xfe, 0x71];
    if code.len() < 3 || !code.starts_with(&prefix) {
        return None;
    }

    let erc_version = (code[2] & 0b11111100) >> 2;
    if erc_version > 0 {
        // Only version 0 is supported right now
        return None;
    }

    let n_length_bytes = (code[2] & 0b11) as usize;
    if n_length_bytes == 0b11 {
        // Reserved bits are set
        return None;
    }

    let data_length = {
        let mut data_length_vec = vec![0u8; 4];
        data_length_vec[4 - n_length_bytes..]
            .copy_from_slice(safe_slice(&code, 3, 3 + n_length_bytes)?.as_ref());
        u32::from_be_bytes(
            data_length_vec
                .try_into()
                .expect("should not panic as original vector is 4 bytes"),
        )
    } as usize;

    let preamble_data = if n_length_bytes == 0 {
        None
    } else {
        let data_start = 3 + n_length_bytes;
        Some(safe_slice(&code, data_start, data_start + data_length)?)
    };

    let initcode = code.slice(3 + n_length_bytes + data_length..);
    if initcode.is_empty() {
        // Initcode cannot be empty
        return None;
    }

    Some(BlueprintContract {
        version: erc_version,
        preamble_data,
        initcode,
    })
}

pub fn from_creation_code(code: Bytes) -> Option<BlueprintContract> {
    if code.len() < 10 {
        return None;
    }

    // code[1], code[2] - the length of "to be deployed" part of the contract
    // https://github.com/vyperlang/vyper/blob/v0.3.10/vyper/compiler/phases.py#L206
    let deploy_bytecode_prefix = [
        0x61, code[1], code[2], 0x3d, 0x81, 0x60, 0x0a, 0x3d, 0x39, 0xf3,
    ];
    if code.starts_with(&deploy_bytecode_prefix) {
        let len_bytes = u16::from_be_bytes([code[1], code[2]]) as usize;
        let blueprint_bytecode = code.slice(deploy_bytecode_prefix.len()..);
        if blueprint_bytecode.len() == len_bytes {
            return from_runtime_code(blueprint_bytecode);
        }
    }

    None
}

/// A safe version of [`bytes::Bytes::slice`].
/// Original method panics in case if `start > end` or `code.len() < end`.
/// In order to not add the check in every place, we use this wrapping function,
/// which encapsulates those conditions and returns `None` if any of them fails.
fn safe_slice(code: &Bytes, start: usize, end: usize) -> Option<Bytes> {
    if start > end || code.len() < end {
        return None;
    }
    Some(code.slice(start..end))
}

#[cfg(test)]
mod tests {
    use super::*;

    fn from_hex(value: &str) -> Bytes {
        let bytes: Vec<u8> = hex::FromHex::from_hex(value).unwrap();
        Bytes::from(bytes)
    }

    fn to_expected_contract(
        version: u8,
        preamble_data: Option<&str>,
        initcode: &str,
    ) -> BlueprintContract {
        BlueprintContract {
            version,
            preamble_data: preamble_data.map(from_hex),
            initcode: from_hex(initcode),
        }
    }

    #[test]
    fn from_runtime_code_success() {
        // A basic check with not very long bytecode
        let code = from_hex("fe71003461002457602061009a5f395f5160015560015f5561005f61002860003961005f6000f35b5f80fd5f3560e01c60026001821660011b61005b01601e395f51565b63158ef93e81186100535734610057575f5460405260206040f3610053565b633fa4f245811861005357346100575760015460405260206040f35b5f5ffd5b5f80fd0018003784185f810400a16576797065728300030a0013");
        let expected_contract = to_expected_contract(0, None, "3461002457602061009a5f395f5160015560015f5561005f61002860003961005f6000f35b5f80fd5f3560e01c60026001821660011b61005b01601e395f51565b63158ef93e81186100535734610057575f5460405260206040f3610053565b633fa4f245811861005357346100575760015460405260206040f35b5f5ffd5b5f80fd0018003784185f810400a16576797065728300030a0013");
        assert_eq!(
            Some(expected_contract),
            from_runtime_code(code),
            "length encoded as 1 byte"
        );

        // A bytecode with length encoded as more than 1 byte
        // https://etherscan.io/address/0x79D584d2D49eC8CE8Ea379d69364b700bd35874D#code
        let code = from_hex("fe71006129c551503461035a576020612cd95f395f518060a01c61035a57604052604051600d5533600b5532600c556040516395d89b4160a052606060a0600460bc845afa61004d573d5f5f3e3d5ffd5b60403d1061035a5760a05160a001602081511161035a5780516101205260208101516101405250610120905080516060526020810151608052505f6009610100527f43757276652e666920000000000000000000000000000000000000000000000061012052610100805160208201836101a00181518152505080830192505050606051816101a001608051815250808201915050600e610140527f204761756765204465706f73697400000000000000000000000000000000000061016052610140805160208201836101a001815181525050808301925050508061018052610180905060208151018060a0828460045afa505050602060a051015f81601f0160051c6003811161035a57801561017957905b8060051b60a001518160040155600101818118610161575b5050505f60605181610160016080518152508082019150506006610100527f2d67617567650000000000000000000000000000000000000000000000000000610120526101008051602082018361016001815181525050808301925050508061014052610140905060208151015f81601f0160051c6003811161035a57801561021557905b8060051b84015181600701556001018181186101fe575b505050504260235563b26b238e610100526020610100600461011c5f73d533a949740bb3306d119cc777fa900ba034cd525af1610254573d5f5f3e3d5ffd5b60203d1061035a576101005160d81b632c4e722e610140526020610140600461015c73d533a949740bb3306d119cc777fa900ba034cd525afa610299573d5f5f3e3d5ffd5b60203d1061035a576101405180820182811061035a5790509050600f5560a05160c0206129655260014303406129a55246612985527f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f6101205261296551610140527f71916ddf3efd1d13d14899519c9cd193fa3f9be07ea852717d2f225de1eb2466610160524661018052306101a0526129a5516101c05260c0610100526101008051602082012090506129c55261296561035e610000396129e5610000f35b5f80fd5f3560e01c6002603f821660011b6128e501601e395f51565b63bfa0b133811861003657346128e15760206129a560403960206040f35b63095ea7b38118611c2d576044361034176128e1576004358060a01c6128e1576040526024356003336020525f5260405f20806040516020525f5260405f20905055604051337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560243560605260206060a3600160605260206060f3611c2d565b6370a0823181186100f2576024361034176128e1576004358060a01c6128e15760405260016040516020525f5260405f205460605260206060f35b6301ddabf18118611c2d576024361034176128e1576004358060a01c6128e15760405260126040516020525f5260405f205460605260206060f3611c2d565b6318160ddd811861014d57346128e15760025460405260206040f35b6323b872dd8118611c2d576064361034176128e1576004358060a01c6128e1576103a0526024358060a01c6128e1576103c0525f546002146128e15760025f5560036103a0516020525f5260405f2080336020525f5260405f209050546103e0527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6103e0511461020b576103e0516044358082038281116128e1579050905060036103a0516020525f5260405f2080336020525f5260405f209050555b6103a0516102e0526103c051610300526044356103205261022a612779565b600161040052602061040060035f55f3611c2d565b63dd62ed3e8118610297576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260036040516020525f5260405f20806060516020525f5260405f2090505460805260206080f35b6384e9bd7e8118611c2d576024361034176128e1576004358060a01c6128e1576102e0525f61030052610f3a56611c2d565b6306fdde03811861034457346128e157602080604052806040016020600454015f81601f0160051c600381116128e157801561031857905b80600401548160051b850152600101818118610301575b5050508051806020830101601f825f03163682375050601f19601f825160200101169050810190506040f35b63331345838118611c2d576024361034176128e1576004358060a01c6128e1576102805261028051604052610377611cc4565b6019610280516020525f5260405f2054638b752bb06102a052610280516102c052306102e05260206102a060446102bc73d061d61a4d941c39e5453435b6345dc261c2fce05afa6103ca573d5f5f3e3d5ffd5b60203d106128e1576102a0518082038281116128e15790509050610300526020610300f3611c2d565b6395d89b418118611c2d57346128e157602080604052806040016020600754015f81601f0160051c600381116128e157801561044257905b80600701548160051b85015260010181811861042b575b5050508051806020830101601f825f03163682375050601f19601f825160200101169050810190506040f3611c2d565b637ecebe0081146003361116156104b3576024361034176128e1576004358060a01c6128e157604052600a6040516020525f5260405f205460605260206060f35b639c868ac08118611c2d57346128e157600e5460405260206040f3611c2d565b63c45a015581186104ef57346128e157600b5460405260206040f35b633644e5158118611c2d57346128e157602061050c610120611c31565b610120f3611c2d565b63481c6a75811861053157346128e157600c5460405260206040f35b6396c551758118611c2d576024361034176128e1576004358060a01c6128e157610280526018610280516020525f5260405f20546102a05263da020a1861032052610280516103405263010ae7576102e052610280516103005260206102e060246102fc735f3b5dfeb7b28cdbd7faba78963ee202a494e2a25afa6105b8573d5f5f3e3d5ffd5b60203d106128e1576102e051610360526020610320604461033c735f3b5dfeb7b28cdbd7faba78963ee202a494e2a25afa6105f5573d5f5f3e3d5ffd5b60203d106128e157610320516102c0526001610280516020525f5260405f20546102e0526370a082316103005261028051610320526020610300602461031c735f3b5dfeb7b28cdbd7faba78963ee202a494e2a25afa610657573d5f5f3e3d5ffd5b60203d106128e1576103005161066e576001610678565b6102a0516102c051115b156128e1576102e051602881028160288204186128e15790506064810490506015610280516020525f5260405f205411156128e157610280516040526106bc611cc4565b610280516040526001610280516020525f5260405f20546060526002546080526106e46125c3565b00611c2d565b6382c630668118611c2d57346128e157600d5460405260206040f3611c2d565b63963c94b98118611c2d57346128e15760105460405260206040f3611c2d565b6348e9c65e8118611c2d576024361034176128e1576004358060a01c6128e15760405260116040516020525f5260405f2080546060526001810154608052600281015460a052600381015460c052600481015460e0526005810154610100525060c06060f3611c2d565b63f05cc0588118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260136040516020525f5260405f20806060516020525f5260405f2090505460805260206080f3611c2d565b6313ecb1ca8118611c2d576024361034176128e1576004358060a01c6128e15760405260156040516020525f5260405f205460605260206060f3611c2d565b6317e280898118611c2d57346128e15760165460405260206040f3611c2d565b63de263bfa8118611c2d576024361034176128e1576004358060a01c6128e15760405260176040516020525f5260405f205460605260206060f3611c2d565b639bd324f281186108c9576024361034176128e1576004358060a01c6128e15760405260186040516020525f5260405f205460605260206060f35b63e6f1daf28118611c2d57346128e157336102e0525f61030052610f3a56611c2d565b63094007078118610927576024361034176128e1576004358060a01c6128e15760405260196040516020525f5260405f205460605260206060f35b6383df67478118611c2d576064361034176128e1576024358060a01c6128e1576102e0526044358060011c6128e157610300525b5f546002146128e15760025f556102e051156128e1576102e051604052610980611cc4565b60043515610af2576010541515610320526002546103405261032051156109c2576102e05160405261034051606052610300516080525f60a0526109c26121f9565b610340516004358082018281106128e157905090506103405260016102e0516020525f5260405f20546004358082018281106128e15790509050610360526103605160016102e0516020525f5260405f2055610340516002556102e0516040526103605160605261034051608052610a386125c3565b600d546323b872dd61038052336103a052306103c0526004356103e0526020610380606461039c5f855af1610a6f573d5f5f3e3d5ffd5b60203d106128e157610380518060011c6128e1576104005261040050506102e0517fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c600435610380526020610380a26102e0515f7fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef600435610380526020610380a35b60035f5500611c2d565b63ef78d4fd8118611c2d57346128e157601a5460405260206040f3611c2d565b6354c49fe98118610b49576024361034176128e157600435600781116128e157601b015460405260206040f35b63be5d1be98118611c2d57346128e157600f5460d81c60405260206040f3611c2d565b637598108c8118610ba5576024361034176128e1576004356c01431e0fae6d7217ca9fffffff81116128e1576023015460405260206040f35b63fec8ee0c8118611c2d576024361034176128e1576004356c01431e0fae6d7217ca9fffffff81116128e1576c01431e0fae6d7217caa0000023015460405260206040f3611c2d565b63b6b55f258118610c12576024361034176128e157336102e0525f6103005261095b565b636e553f658118611c2d576044361034176128e1576024358060a01c6128e1576102e0525f6103005261095b56611c2d565b632e1a7d4d8118610c63576024361034176128e1575f6102e052610d88565b63e8de0d4d8118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605233600c548118610ca5576001610ce8565b600b5463f851a44060e052602060e0600460fc845afa610cc7573d5f5f3e3d5ffd5b60203d106128e15760e0518060a01c6128e157610120526101209050518118155b9050156128e157606051156128e1576010546080526007608051116128e15760116040516020525f5260405f20600181019050546128e15760605160116040516020525f5260405f2060018101905055604051608051600781116128e157601b0155608051600181018181106128e157905060105500611c2d565b6338d074368118611c2d576044361034176128e1576024358060011c6128e1576102e0525b5f546002146128e15760025f5533604052610da1611cc4565b60043515610e9d57601054151561030052600254610320526103005115610de05733604052610320516060526102e0516080525f60a052610de06121f9565b610320516004358082038281116128e15790509050610320526001336020525f5260405f20546004358082038281116128e1579050905061034052610340516001336020525f5260405f205561032051600255336040526103405160605261032051608052610e4d6125c3565b600d5463a9059cbb6103605233610380526004356103a0526020610360604461037c5f855af1610e7f573d5f5f3e3d5ffd5b60203d106128e157610360518060011c6128e1576103c0526103c050505b337f884edad9ce6fa2440d8a54cc123490eb96d2768479d49ff9c7366125a9424364600435610300526020610300a25f337fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef600435610300526020610300a360035f5500611c2d565b639faceb1b8118611c2d576044361034176128e1576004358060a01c6128e1576102e0526024358060a01c6128e157610300525b5f546002146128e15760025f556103005115610f5b57336102e051186128e1575b6102e05160405260025460605260016080526103005160a052610f7c6121f9565b60035f5500611c2d565b63a9059cbb8118611c2d576044361034176128e1576004358060a01c6128e1576103a0525f546002146128e15760025f55336102e0526103a0516103005260243561032052610fd3612779565b60016103c05260206103c060035f55f3611c2d565b63d505accf8118611c2d5760e4361034176128e1576004358060a01c6128e157610120526024358060a01c6128e157610140526084358060081c6128e1576101605261012051156128e15760643542116128e157600a610120516020525f5260405f2054610180525f60026101c0527f19010000000000000000000000000000000000000000000000000000000000006101e0526101c08051602082018361032001815181525050808301925050506110a2610200611c31565b610200518161032001526020810190507f6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c961024052610120516102605261014051610280526044356102a052610180516102c0526064356102e05260c061022052610220805160208201209050816103200152602081019050806103005261030090508051602082012090506101a052610120515f610240526101a0516101c052610160516101e052604060a461020037602061024060806101c060015afa5061024051186128e1576044356003610120516020525f5260405f2080610140516020525f5260405f2090505560016101805101600a610120516020525f5260405f205561014051610120517f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9256044356101c05260206101c0a360016101c05260206101c0f3611c2d565b63395093518118611c2d576044361034176128e1576004358060a01c6128e1576040526003336020525f5260405f20806040516020525f5260405f209050546024358082018281106128e157905090506060526060516003336020525f5260405f20806040516020525f5260405f20905055604051337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560605160805260206080a3600160805260206080f3611c2d565b63a457c2d7811861134a576044361034176128e1576004358060a01c6128e1576040526003336020525f5260405f20806040516020525f5260405f209050546024358082038281116128e157905090506060526060516003336020525f5260405f20806040516020525f5260405f20905055604051337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560605160805260206080a3600160805260206080f35b6390b229978118611c2d576024361034176128e1576004358060011c6128e157604052600b5463f851a440606052602060606004607c845afa61138f573d5f5f3e3d5ffd5b60203d106128e1576060518060a01c6128e15760a05260a090505133186128e157604051600e5500611c2d565b634b8200938118611c2d576024361034176128e1576004358060a01c6128e15761028052336102805181186113f257600161140b565b73d061d61a4d941c39e5453435b6345dc261c2fce08118155b9050156128e15761028051604052611421611cc4565b610280516040526001610280516020525f5260405f20546060526002546080526114496125c3565b60016102a05260206102a0f3611c2d565b63bdf981168118611c2d576024361034176128e1576004358060a01c6128e1576040526040516012336020525f5260405f205500611c2d565b63aace1d488118611c2d576024361034176128e1576004358060a01c6128e15760405233600c5481186114c757600161150a565b600b5463f851a44060c052602060c0600460dc845afa6114e9573d5f5f3e3d5ffd5b60203d106128e15760c0518060a01c6128e157610100526101009050518118155b9050156128e157604051600c557fe83c80a0349150991cb09b4c940149ac4c37cb03673b6c0c669b4da27865c28b60405160605260206060a100611c2d565b6393f7aa67811861156b576044361034176128e15762093a80610300526115a7565b63313ce5678118611c2d57346128e157601260405260206040f3611c2d565b6333b50aed8118611826576064361034176128e157604435610300525b6004358060a01c6128e1576102e0525f546002146128e15760025f5560116102e0516020525f5260405f206001810190505433186128e1575f6040526002546060526040366080376115f76121f9565b6102e0516370a082316103405230610360526020610340602461035c845afa611622573d5f5f3e3d5ffd5b60203d106128e157610340905051610320526102e0516323b872dd61034052336103605230610380526024356103a0526020610340606461035c5f855af161166c573d5f5f3e3d5ffd5b3d61168357803b156128e15760016103c05261169c565b60203d106128e157610340518060011c6128e1576103c0525b6103c0905051156128e1576102e0516370a082316103405230610360526020610340602461035c845afa6116d2573d5f5f3e3d5ffd5b60203d106128e157610340905051610320518082038281116128e157905090506103205260116102e0516020525f5260405f206002810190505461034052610300516103205111156128e157610340514210156117b45761034051428082038281116128e15790509050610360526103605160116102e0516020525f5260405f20600381019050548082028115838383041417156128e157905090506103805261032051610380518082018281106128e157905090506103005180156128e1578082049050905060116102e0516020525f5260405f20600381019050556117e0565b610320516103005180156128e1578082049050905060116102e0516020525f5260405f20600381019050555b4260116102e0516020525f5260405f206004810190505542610300518082018281106128e1579050905060116102e0516020525f5260405f206002810190505560035f55005b63d31f3f6d8118611c2d57346128e157601a546c01431e0fae6d7217ca9fffffff81116128e1576023015460405260206040f3611c2d565b63058a3a248118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260116040516020525f5260405f20600181019050546080523360805181186118b857600161190f565b600b5463f851a440610100526020610100600461011c845afa6118dd573d5f5f3e3d5ffd5b60203d106128e157610100518060a01c6128e15761014052610140905051811861190857600161190f565b600c548118155b9050156128e157608051156128e157606051156128e15760605160116040516020525f5260405f206001810190505500611c2d565b63e77e74378118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260146040516020525f5260405f20806060516020525f5260405f209050546fffffffffffffffffffffffffffffffff8116905060805260206080f3611c2d565b6333fd6f748118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260116060516020525f5260405f206005810190505460805260025460a05260a05115611aca574260116060516020525f5260405f20600281019050548082811882841002189050905060c05260c05160116060516020525f5260405f20600481019050548082038281116128e1579050905060e05260805160e05160116060516020525f5260405f20600381019050548082028115838383041417156128e15790509050670de0b6b3a7640000810281670de0b6b3a76400008204186128e157905060a05180156128e157808204905090508082018281106128e157905090506080525b60136060516020525f5260405f20806040516020525f5260405f2090505460c05260016040516020525f5260405f205460805160c0518082038281116128e157905090508082028115838383041417156128e15790509050670de0b6b3a76400008104905060e05260146040516020525f5260405f20806060516020525f5260405f2090505460801c60e0518082018281106128e15790509050610100526020610100f3611c2d565b63180692d08118611baf57346128e157600f547affffffffffffffffffffffffffffffffffffffffffffffffffffff8116905060405260206040f35b6354fd4d508118611c2d57346128e15760208060805260066040527f76362e312e30000000000000000000000000000000000000000000000000000060605260408160800181518152602082015160208201528051806020830101601f825f03163682375050601f19601f8251602001011690509050810190506080f35b5f5ffd5b60206129855f395f514614611cb9577f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f60605260206129656080397f71916ddf3efd1d13d14899519c9cd193fa3f9be07ea852717d2f225de1eb246660a0524660c0523060e05260206129a56101003960c06040526040805160208201209050815250611cc2565b60206129c58239505b565b601a546060526060516c01431e0fae6d7217ca9fffffff81116128e157602301546080526060516c01431e0fae6d7217ca9fffffff81116128e1576c01431e0fae6d7217caa0000023015460a052600f5460c05260c05160d81c60e052600e546101005260c0517affffffffffffffffffffffffffffffffffffffffffffffffffffff811690506101205261012051610140526101005115611d6857604036610120375b60805160e05110611e265763b26b238e610180526020610180600461019c5f73d533a949740bb3306d119cc777fa900ba034cd525af1611daa573d5f5f3e3d5ffd5b60203d106128e157610180516101605261010051611e0957632c4e722e610180526020610180600461019c73d533a949740bb3306d119cc777fa900ba034cd525afa611df8573d5f5f3e3d5ffd5b60203d106128e15761018051610140525b6101605160d81b610140518082018281106128e15790509050600f555b6080514211156120fa576016546101605263615e523761018052306101a052732f50d538606fa9edd2b11e2446beb18c9d5846bb3b156128e1575f610180602461019c5f732f50d538606fa9edd2b11e2446beb18c9d5846bb5af1611e8d573d5f5f3e3d5ffd5b6080516101805260805162093a8081018181106128e157905062093a808104905062093a8081028162093a808204186128e157905042808281188284100218905090506101a0525f6101f4905b806101c0526101a051610180518082038281116128e157905090506101e05263d3078c9461022052306102405261018051610260526020610220604461023c732f50d538606fa9edd2b11e2446beb18c9d5846bb5afa611f3c573d5f5f3e3d5ffd5b60203d106128e157610220516102005261016051156120b0576101805160e0511015611f68575f611f71565b6101a05160e051105b611fd35760a05161012051610200518082028115838383041417156128e157905090506101e0518082028115838383041417156128e157905090506101605180156128e157808204905090508082018281106128e1579050905060a0526120b0565b60a05161012051610200518082028115838383041417156128e1579050905060e051610180518082038281116128e157905090508082028115838383041417156128e157905090506101605180156128e157808204905090508082018281106128e1579050905060a052610140516101205260a05161012051610200518082028115838383041417156128e157905090506101a05160e0518082038281116128e157905090508082028115838383041417156128e157905090506101605180156128e157808204905090508082018281106128e1579050905060a0525b426101a051186120bf576120f7565b6101a051610180526101a05162093a8081018181106128e157905042808281188284100218905090506101a052600101818118611eda575b50505b6060516001810180600f0b81186128e1579050606052606051601a55426060516c01431e0fae6d7217ca9fffffff81116128e1576023015560a0516060516c01431e0fae6d7217ca9fffffff81116128e1576c01431e0fae6d7217caa0000023015560156040516020525f5260405f20546101605260196040516020525f5260405f2080546101605160a05160176040516020525f5260405f20548082038281116128e157905090508082028115838383041417156128e15790509050670de0b6b3a7640000810490508082018281106128e1579050905081555060a05160176040516020525f5260405f20554260186040516020525f5260405f2055565b5f60c05260a05160e052604051156122545760016040516020525f5260405f205460c05260805161222a575f61222f565b60a051155b156122545760126040516020525f5260405f205460e05260e0516122545760405160e0525b601054610100525f6008905b8061012052610100516101205118612277576125bf565b61012051600781116128e157601b0154610140526011610140516020525f5260405f206005810190505461016052426011610140516020525f5260405f20600281019050548082811882841002189050905061018052610180516011610140516020525f5260405f20600481019050548082038281116128e157905090506101a0526101a0511561230c57606051151561230e565b5f5b156123ba57610180516011610140516020525f5260405f2060048101905055610160516101a0516011610140516020525f5260405f20600381019050548082028115838383041417156128e15790509050670de0b6b3a7640000810281670de0b6b3a76400008204186128e157905060605180156128e157808204905090508082018281106128e1579050905061016052610160516011610140516020525f5260405f20600581019050555b604051156125b4576013610140516020525f5260405f20806040516020525f5260405f209050546101c0525f6101e052610160516101c051101561245a57610160516013610140516020525f5260405f20806040516020525f5260405f2090505560c051610160516101c0518082038281116128e157905090508082028115838383041417156128e15790509050670de0b6b3a7640000810490506101e0525b60146040516020525f5260405f2080610140516020525f5260405f20905054610200526102005160801c6101e0518082018281106128e157905090506102205261022051156125b457610200516fffffffffffffffffffffffffffffffff811690506102405260805161250d576101e051156125b457610240516102205160801b8082018281106128e1579050905060146040516020525f5260405f2080610140516020525f5260405f209050556125b4565b6101405163a9059cbb6102605260e05161028052610220516102a0526020610260604461027c5f855af1612543573d5f5f3e3d5ffd5b3d61255a57803b156128e15760016102c052612573565b60203d106128e157610260518060011c6128e1576102c0525b6102c0905051156128e15761024051610220518082018281106128e1579050905060146040516020525f5260405f2080610140516020525f5260405f209050555b600101818118612260575b5050565b63bbf7408a60c05260405160e052602060c0602460dc738e0c00ed546602fd9927df742bbabf726d5b0d165afa6125fc573d5f5f3e3d5ffd5b60203d106128e15760c05160a0526318160ddd60e052602060e0600460fc735f3b5dfeb7b28cdbd7faba78963ee202a494e2a25afa61263d573d5f5f3e3d5ffd5b60203d106128e15760e05160c052606051602881028160288204186128e157905060648104905060e05260c051156126c45760e05160805160a0518082028115838383041417156128e1579050905060c05180156128e15780820490509050603c810281603c8204186128e15790506064810490508082018281106128e1579050905060e0525b60605160e0518082811882841002189050905060e05260156040516020525f5260405f20546101005260e05160156040516020525f5260405f205560165460e0518082018281106128e15790509050610100518082038281116128e1579050905061012052610120516016556040517f7ecd84343f76a23d2227290e0288da3251b045541698e575a5515af4f04197a3606051610140526080516101605260e05161018052610120516101a0526080610140a2565b6102e051604052612788611cc4565b61030051604052612797611cc4565b61032051156128a8576002546103405260105415156103605261036051156127d5576102e051604052610340516060526040366080376127d56121f9565b60016102e0516020525f5260405f2054610320518082038281116128e15790509050610380526103805160016102e0516020525f5260405f20556102e051604052610380516060526103405160805261282c6125c3565b61036051156128515761030051604052610340516060526040366080376128516121f9565b6001610300516020525f5260405f2054610320518082018281106128e1579050905061038052610380516001610300516020525f5260405f20556103005160405261038051606052610340516080526128a86125c3565b610300516102e0517fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef61032051610340526020610340a3565b5f80fd047203f31c2d02c91c2d1c2d1c2d08ec1493082f07f01c2d0b6c0c441c2d0fe81b7311ec1c2d13bc1c2d04d3145a129d07941c2d1c2d0f061c2d0131072a1c2d1c2d1c2d1c2d1c2d185e0bee06ea15491c2d0b1c1c2d1c2d1c2d158a1c2d1c2d1c2d00b7088e001819b505150d6319441c2d070a084f0f861c2d0afc023f1c2d841929658118801880a16576797065728300030a0016");
        // https://etherscan.io/address/0xad7b288315b0d71d62827338251a8d89a98132a0#code
        let expected_contract = to_expected_contract(0, None, "6129c551503461035a576020612cd95f395f518060a01c61035a57604052604051600d5533600b5532600c556040516395d89b4160a052606060a0600460bc845afa61004d573d5f5f3e3d5ffd5b60403d1061035a5760a05160a001602081511161035a5780516101205260208101516101405250610120905080516060526020810151608052505f6009610100527f43757276652e666920000000000000000000000000000000000000000000000061012052610100805160208201836101a00181518152505080830192505050606051816101a001608051815250808201915050600e610140527f204761756765204465706f73697400000000000000000000000000000000000061016052610140805160208201836101a001815181525050808301925050508061018052610180905060208151018060a0828460045afa505050602060a051015f81601f0160051c6003811161035a57801561017957905b8060051b60a001518160040155600101818118610161575b5050505f60605181610160016080518152508082019150506006610100527f2d67617567650000000000000000000000000000000000000000000000000000610120526101008051602082018361016001815181525050808301925050508061014052610140905060208151015f81601f0160051c6003811161035a57801561021557905b8060051b84015181600701556001018181186101fe575b505050504260235563b26b238e610100526020610100600461011c5f73d533a949740bb3306d119cc777fa900ba034cd525af1610254573d5f5f3e3d5ffd5b60203d1061035a576101005160d81b632c4e722e610140526020610140600461015c73d533a949740bb3306d119cc777fa900ba034cd525afa610299573d5f5f3e3d5ffd5b60203d1061035a576101405180820182811061035a5790509050600f5560a05160c0206129655260014303406129a55246612985527f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f6101205261296551610140527f71916ddf3efd1d13d14899519c9cd193fa3f9be07ea852717d2f225de1eb2466610160524661018052306101a0526129a5516101c05260c0610100526101008051602082012090506129c55261296561035e610000396129e5610000f35b5f80fd5f3560e01c6002603f821660011b6128e501601e395f51565b63bfa0b133811861003657346128e15760206129a560403960206040f35b63095ea7b38118611c2d576044361034176128e1576004358060a01c6128e1576040526024356003336020525f5260405f20806040516020525f5260405f20905055604051337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560243560605260206060a3600160605260206060f3611c2d565b6370a0823181186100f2576024361034176128e1576004358060a01c6128e15760405260016040516020525f5260405f205460605260206060f35b6301ddabf18118611c2d576024361034176128e1576004358060a01c6128e15760405260126040516020525f5260405f205460605260206060f3611c2d565b6318160ddd811861014d57346128e15760025460405260206040f35b6323b872dd8118611c2d576064361034176128e1576004358060a01c6128e1576103a0526024358060a01c6128e1576103c0525f546002146128e15760025f5560036103a0516020525f5260405f2080336020525f5260405f209050546103e0527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6103e0511461020b576103e0516044358082038281116128e1579050905060036103a0516020525f5260405f2080336020525f5260405f209050555b6103a0516102e0526103c051610300526044356103205261022a612779565b600161040052602061040060035f55f3611c2d565b63dd62ed3e8118610297576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260036040516020525f5260405f20806060516020525f5260405f2090505460805260206080f35b6384e9bd7e8118611c2d576024361034176128e1576004358060a01c6128e1576102e0525f61030052610f3a56611c2d565b6306fdde03811861034457346128e157602080604052806040016020600454015f81601f0160051c600381116128e157801561031857905b80600401548160051b850152600101818118610301575b5050508051806020830101601f825f03163682375050601f19601f825160200101169050810190506040f35b63331345838118611c2d576024361034176128e1576004358060a01c6128e1576102805261028051604052610377611cc4565b6019610280516020525f5260405f2054638b752bb06102a052610280516102c052306102e05260206102a060446102bc73d061d61a4d941c39e5453435b6345dc261c2fce05afa6103ca573d5f5f3e3d5ffd5b60203d106128e1576102a0518082038281116128e15790509050610300526020610300f3611c2d565b6395d89b418118611c2d57346128e157602080604052806040016020600754015f81601f0160051c600381116128e157801561044257905b80600701548160051b85015260010181811861042b575b5050508051806020830101601f825f03163682375050601f19601f825160200101169050810190506040f3611c2d565b637ecebe0081146003361116156104b3576024361034176128e1576004358060a01c6128e157604052600a6040516020525f5260405f205460605260206060f35b639c868ac08118611c2d57346128e157600e5460405260206040f3611c2d565b63c45a015581186104ef57346128e157600b5460405260206040f35b633644e5158118611c2d57346128e157602061050c610120611c31565b610120f3611c2d565b63481c6a75811861053157346128e157600c5460405260206040f35b6396c551758118611c2d576024361034176128e1576004358060a01c6128e157610280526018610280516020525f5260405f20546102a05263da020a1861032052610280516103405263010ae7576102e052610280516103005260206102e060246102fc735f3b5dfeb7b28cdbd7faba78963ee202a494e2a25afa6105b8573d5f5f3e3d5ffd5b60203d106128e1576102e051610360526020610320604461033c735f3b5dfeb7b28cdbd7faba78963ee202a494e2a25afa6105f5573d5f5f3e3d5ffd5b60203d106128e157610320516102c0526001610280516020525f5260405f20546102e0526370a082316103005261028051610320526020610300602461031c735f3b5dfeb7b28cdbd7faba78963ee202a494e2a25afa610657573d5f5f3e3d5ffd5b60203d106128e1576103005161066e576001610678565b6102a0516102c051115b156128e1576102e051602881028160288204186128e15790506064810490506015610280516020525f5260405f205411156128e157610280516040526106bc611cc4565b610280516040526001610280516020525f5260405f20546060526002546080526106e46125c3565b00611c2d565b6382c630668118611c2d57346128e157600d5460405260206040f3611c2d565b63963c94b98118611c2d57346128e15760105460405260206040f3611c2d565b6348e9c65e8118611c2d576024361034176128e1576004358060a01c6128e15760405260116040516020525f5260405f2080546060526001810154608052600281015460a052600381015460c052600481015460e0526005810154610100525060c06060f3611c2d565b63f05cc0588118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260136040516020525f5260405f20806060516020525f5260405f2090505460805260206080f3611c2d565b6313ecb1ca8118611c2d576024361034176128e1576004358060a01c6128e15760405260156040516020525f5260405f205460605260206060f3611c2d565b6317e280898118611c2d57346128e15760165460405260206040f3611c2d565b63de263bfa8118611c2d576024361034176128e1576004358060a01c6128e15760405260176040516020525f5260405f205460605260206060f3611c2d565b639bd324f281186108c9576024361034176128e1576004358060a01c6128e15760405260186040516020525f5260405f205460605260206060f35b63e6f1daf28118611c2d57346128e157336102e0525f61030052610f3a56611c2d565b63094007078118610927576024361034176128e1576004358060a01c6128e15760405260196040516020525f5260405f205460605260206060f35b6383df67478118611c2d576064361034176128e1576024358060a01c6128e1576102e0526044358060011c6128e157610300525b5f546002146128e15760025f556102e051156128e1576102e051604052610980611cc4565b60043515610af2576010541515610320526002546103405261032051156109c2576102e05160405261034051606052610300516080525f60a0526109c26121f9565b610340516004358082018281106128e157905090506103405260016102e0516020525f5260405f20546004358082018281106128e15790509050610360526103605160016102e0516020525f5260405f2055610340516002556102e0516040526103605160605261034051608052610a386125c3565b600d546323b872dd61038052336103a052306103c0526004356103e0526020610380606461039c5f855af1610a6f573d5f5f3e3d5ffd5b60203d106128e157610380518060011c6128e1576104005261040050506102e0517fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c600435610380526020610380a26102e0515f7fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef600435610380526020610380a35b60035f5500611c2d565b63ef78d4fd8118611c2d57346128e157601a5460405260206040f3611c2d565b6354c49fe98118610b49576024361034176128e157600435600781116128e157601b015460405260206040f35b63be5d1be98118611c2d57346128e157600f5460d81c60405260206040f3611c2d565b637598108c8118610ba5576024361034176128e1576004356c01431e0fae6d7217ca9fffffff81116128e1576023015460405260206040f35b63fec8ee0c8118611c2d576024361034176128e1576004356c01431e0fae6d7217ca9fffffff81116128e1576c01431e0fae6d7217caa0000023015460405260206040f3611c2d565b63b6b55f258118610c12576024361034176128e157336102e0525f6103005261095b565b636e553f658118611c2d576044361034176128e1576024358060a01c6128e1576102e0525f6103005261095b56611c2d565b632e1a7d4d8118610c63576024361034176128e1575f6102e052610d88565b63e8de0d4d8118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605233600c548118610ca5576001610ce8565b600b5463f851a44060e052602060e0600460fc845afa610cc7573d5f5f3e3d5ffd5b60203d106128e15760e0518060a01c6128e157610120526101209050518118155b9050156128e157606051156128e1576010546080526007608051116128e15760116040516020525f5260405f20600181019050546128e15760605160116040516020525f5260405f2060018101905055604051608051600781116128e157601b0155608051600181018181106128e157905060105500611c2d565b6338d074368118611c2d576044361034176128e1576024358060011c6128e1576102e0525b5f546002146128e15760025f5533604052610da1611cc4565b60043515610e9d57601054151561030052600254610320526103005115610de05733604052610320516060526102e0516080525f60a052610de06121f9565b610320516004358082038281116128e15790509050610320526001336020525f5260405f20546004358082038281116128e1579050905061034052610340516001336020525f5260405f205561032051600255336040526103405160605261032051608052610e4d6125c3565b600d5463a9059cbb6103605233610380526004356103a0526020610360604461037c5f855af1610e7f573d5f5f3e3d5ffd5b60203d106128e157610360518060011c6128e1576103c0526103c050505b337f884edad9ce6fa2440d8a54cc123490eb96d2768479d49ff9c7366125a9424364600435610300526020610300a25f337fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef600435610300526020610300a360035f5500611c2d565b639faceb1b8118611c2d576044361034176128e1576004358060a01c6128e1576102e0526024358060a01c6128e157610300525b5f546002146128e15760025f556103005115610f5b57336102e051186128e1575b6102e05160405260025460605260016080526103005160a052610f7c6121f9565b60035f5500611c2d565b63a9059cbb8118611c2d576044361034176128e1576004358060a01c6128e1576103a0525f546002146128e15760025f55336102e0526103a0516103005260243561032052610fd3612779565b60016103c05260206103c060035f55f3611c2d565b63d505accf8118611c2d5760e4361034176128e1576004358060a01c6128e157610120526024358060a01c6128e157610140526084358060081c6128e1576101605261012051156128e15760643542116128e157600a610120516020525f5260405f2054610180525f60026101c0527f19010000000000000000000000000000000000000000000000000000000000006101e0526101c08051602082018361032001815181525050808301925050506110a2610200611c31565b610200518161032001526020810190507f6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c961024052610120516102605261014051610280526044356102a052610180516102c0526064356102e05260c061022052610220805160208201209050816103200152602081019050806103005261030090508051602082012090506101a052610120515f610240526101a0516101c052610160516101e052604060a461020037602061024060806101c060015afa5061024051186128e1576044356003610120516020525f5260405f2080610140516020525f5260405f2090505560016101805101600a610120516020525f5260405f205561014051610120517f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9256044356101c05260206101c0a360016101c05260206101c0f3611c2d565b63395093518118611c2d576044361034176128e1576004358060a01c6128e1576040526003336020525f5260405f20806040516020525f5260405f209050546024358082018281106128e157905090506060526060516003336020525f5260405f20806040516020525f5260405f20905055604051337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560605160805260206080a3600160805260206080f3611c2d565b63a457c2d7811861134a576044361034176128e1576004358060a01c6128e1576040526003336020525f5260405f20806040516020525f5260405f209050546024358082038281116128e157905090506060526060516003336020525f5260405f20806040516020525f5260405f20905055604051337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560605160805260206080a3600160805260206080f35b6390b229978118611c2d576024361034176128e1576004358060011c6128e157604052600b5463f851a440606052602060606004607c845afa61138f573d5f5f3e3d5ffd5b60203d106128e1576060518060a01c6128e15760a05260a090505133186128e157604051600e5500611c2d565b634b8200938118611c2d576024361034176128e1576004358060a01c6128e15761028052336102805181186113f257600161140b565b73d061d61a4d941c39e5453435b6345dc261c2fce08118155b9050156128e15761028051604052611421611cc4565b610280516040526001610280516020525f5260405f20546060526002546080526114496125c3565b60016102a05260206102a0f3611c2d565b63bdf981168118611c2d576024361034176128e1576004358060a01c6128e1576040526040516012336020525f5260405f205500611c2d565b63aace1d488118611c2d576024361034176128e1576004358060a01c6128e15760405233600c5481186114c757600161150a565b600b5463f851a44060c052602060c0600460dc845afa6114e9573d5f5f3e3d5ffd5b60203d106128e15760c0518060a01c6128e157610100526101009050518118155b9050156128e157604051600c557fe83c80a0349150991cb09b4c940149ac4c37cb03673b6c0c669b4da27865c28b60405160605260206060a100611c2d565b6393f7aa67811861156b576044361034176128e15762093a80610300526115a7565b63313ce5678118611c2d57346128e157601260405260206040f3611c2d565b6333b50aed8118611826576064361034176128e157604435610300525b6004358060a01c6128e1576102e0525f546002146128e15760025f5560116102e0516020525f5260405f206001810190505433186128e1575f6040526002546060526040366080376115f76121f9565b6102e0516370a082316103405230610360526020610340602461035c845afa611622573d5f5f3e3d5ffd5b60203d106128e157610340905051610320526102e0516323b872dd61034052336103605230610380526024356103a0526020610340606461035c5f855af161166c573d5f5f3e3d5ffd5b3d61168357803b156128e15760016103c05261169c565b60203d106128e157610340518060011c6128e1576103c0525b6103c0905051156128e1576102e0516370a082316103405230610360526020610340602461035c845afa6116d2573d5f5f3e3d5ffd5b60203d106128e157610340905051610320518082038281116128e157905090506103205260116102e0516020525f5260405f206002810190505461034052610300516103205111156128e157610340514210156117b45761034051428082038281116128e15790509050610360526103605160116102e0516020525f5260405f20600381019050548082028115838383041417156128e157905090506103805261032051610380518082018281106128e157905090506103005180156128e1578082049050905060116102e0516020525f5260405f20600381019050556117e0565b610320516103005180156128e1578082049050905060116102e0516020525f5260405f20600381019050555b4260116102e0516020525f5260405f206004810190505542610300518082018281106128e1579050905060116102e0516020525f5260405f206002810190505560035f55005b63d31f3f6d8118611c2d57346128e157601a546c01431e0fae6d7217ca9fffffff81116128e1576023015460405260206040f3611c2d565b63058a3a248118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260116040516020525f5260405f20600181019050546080523360805181186118b857600161190f565b600b5463f851a440610100526020610100600461011c845afa6118dd573d5f5f3e3d5ffd5b60203d106128e157610100518060a01c6128e15761014052610140905051811861190857600161190f565b600c548118155b9050156128e157608051156128e157606051156128e15760605160116040516020525f5260405f206001810190505500611c2d565b63e77e74378118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260146040516020525f5260405f20806060516020525f5260405f209050546fffffffffffffffffffffffffffffffff8116905060805260206080f3611c2d565b6333fd6f748118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260116060516020525f5260405f206005810190505460805260025460a05260a05115611aca574260116060516020525f5260405f20600281019050548082811882841002189050905060c05260c05160116060516020525f5260405f20600481019050548082038281116128e1579050905060e05260805160e05160116060516020525f5260405f20600381019050548082028115838383041417156128e15790509050670de0b6b3a7640000810281670de0b6b3a76400008204186128e157905060a05180156128e157808204905090508082018281106128e157905090506080525b60136060516020525f5260405f20806040516020525f5260405f2090505460c05260016040516020525f5260405f205460805160c0518082038281116128e157905090508082028115838383041417156128e15790509050670de0b6b3a76400008104905060e05260146040516020525f5260405f20806060516020525f5260405f2090505460801c60e0518082018281106128e15790509050610100526020610100f3611c2d565b63180692d08118611baf57346128e157600f547affffffffffffffffffffffffffffffffffffffffffffffffffffff8116905060405260206040f35b6354fd4d508118611c2d57346128e15760208060805260066040527f76362e312e30000000000000000000000000000000000000000000000000000060605260408160800181518152602082015160208201528051806020830101601f825f03163682375050601f19601f8251602001011690509050810190506080f35b5f5ffd5b60206129855f395f514614611cb9577f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f60605260206129656080397f71916ddf3efd1d13d14899519c9cd193fa3f9be07ea852717d2f225de1eb246660a0524660c0523060e05260206129a56101003960c06040526040805160208201209050815250611cc2565b60206129c58239505b565b601a546060526060516c01431e0fae6d7217ca9fffffff81116128e157602301546080526060516c01431e0fae6d7217ca9fffffff81116128e1576c01431e0fae6d7217caa0000023015460a052600f5460c05260c05160d81c60e052600e546101005260c0517affffffffffffffffffffffffffffffffffffffffffffffffffffff811690506101205261012051610140526101005115611d6857604036610120375b60805160e05110611e265763b26b238e610180526020610180600461019c5f73d533a949740bb3306d119cc777fa900ba034cd525af1611daa573d5f5f3e3d5ffd5b60203d106128e157610180516101605261010051611e0957632c4e722e610180526020610180600461019c73d533a949740bb3306d119cc777fa900ba034cd525afa611df8573d5f5f3e3d5ffd5b60203d106128e15761018051610140525b6101605160d81b610140518082018281106128e15790509050600f555b6080514211156120fa576016546101605263615e523761018052306101a052732f50d538606fa9edd2b11e2446beb18c9d5846bb3b156128e1575f610180602461019c5f732f50d538606fa9edd2b11e2446beb18c9d5846bb5af1611e8d573d5f5f3e3d5ffd5b6080516101805260805162093a8081018181106128e157905062093a808104905062093a8081028162093a808204186128e157905042808281188284100218905090506101a0525f6101f4905b806101c0526101a051610180518082038281116128e157905090506101e05263d3078c9461022052306102405261018051610260526020610220604461023c732f50d538606fa9edd2b11e2446beb18c9d5846bb5afa611f3c573d5f5f3e3d5ffd5b60203d106128e157610220516102005261016051156120b0576101805160e0511015611f68575f611f71565b6101a05160e051105b611fd35760a05161012051610200518082028115838383041417156128e157905090506101e0518082028115838383041417156128e157905090506101605180156128e157808204905090508082018281106128e1579050905060a0526120b0565b60a05161012051610200518082028115838383041417156128e1579050905060e051610180518082038281116128e157905090508082028115838383041417156128e157905090506101605180156128e157808204905090508082018281106128e1579050905060a052610140516101205260a05161012051610200518082028115838383041417156128e157905090506101a05160e0518082038281116128e157905090508082028115838383041417156128e157905090506101605180156128e157808204905090508082018281106128e1579050905060a0525b426101a051186120bf576120f7565b6101a051610180526101a05162093a8081018181106128e157905042808281188284100218905090506101a052600101818118611eda575b50505b6060516001810180600f0b81186128e1579050606052606051601a55426060516c01431e0fae6d7217ca9fffffff81116128e1576023015560a0516060516c01431e0fae6d7217ca9fffffff81116128e1576c01431e0fae6d7217caa0000023015560156040516020525f5260405f20546101605260196040516020525f5260405f2080546101605160a05160176040516020525f5260405f20548082038281116128e157905090508082028115838383041417156128e15790509050670de0b6b3a7640000810490508082018281106128e1579050905081555060a05160176040516020525f5260405f20554260186040516020525f5260405f2055565b5f60c05260a05160e052604051156122545760016040516020525f5260405f205460c05260805161222a575f61222f565b60a051155b156122545760126040516020525f5260405f205460e05260e0516122545760405160e0525b601054610100525f6008905b8061012052610100516101205118612277576125bf565b61012051600781116128e157601b0154610140526011610140516020525f5260405f206005810190505461016052426011610140516020525f5260405f20600281019050548082811882841002189050905061018052610180516011610140516020525f5260405f20600481019050548082038281116128e157905090506101a0526101a0511561230c57606051151561230e565b5f5b156123ba57610180516011610140516020525f5260405f2060048101905055610160516101a0516011610140516020525f5260405f20600381019050548082028115838383041417156128e15790509050670de0b6b3a7640000810281670de0b6b3a76400008204186128e157905060605180156128e157808204905090508082018281106128e1579050905061016052610160516011610140516020525f5260405f20600581019050555b604051156125b4576013610140516020525f5260405f20806040516020525f5260405f209050546101c0525f6101e052610160516101c051101561245a57610160516013610140516020525f5260405f20806040516020525f5260405f2090505560c051610160516101c0518082038281116128e157905090508082028115838383041417156128e15790509050670de0b6b3a7640000810490506101e0525b60146040516020525f5260405f2080610140516020525f5260405f20905054610200526102005160801c6101e0518082018281106128e157905090506102205261022051156125b457610200516fffffffffffffffffffffffffffffffff811690506102405260805161250d576101e051156125b457610240516102205160801b8082018281106128e1579050905060146040516020525f5260405f2080610140516020525f5260405f209050556125b4565b6101405163a9059cbb6102605260e05161028052610220516102a0526020610260604461027c5f855af1612543573d5f5f3e3d5ffd5b3d61255a57803b156128e15760016102c052612573565b60203d106128e157610260518060011c6128e1576102c0525b6102c0905051156128e15761024051610220518082018281106128e1579050905060146040516020525f5260405f2080610140516020525f5260405f209050555b600101818118612260575b5050565b63bbf7408a60c05260405160e052602060c0602460dc738e0c00ed546602fd9927df742bbabf726d5b0d165afa6125fc573d5f5f3e3d5ffd5b60203d106128e15760c05160a0526318160ddd60e052602060e0600460fc735f3b5dfeb7b28cdbd7faba78963ee202a494e2a25afa61263d573d5f5f3e3d5ffd5b60203d106128e15760e05160c052606051602881028160288204186128e157905060648104905060e05260c051156126c45760e05160805160a0518082028115838383041417156128e1579050905060c05180156128e15780820490509050603c810281603c8204186128e15790506064810490508082018281106128e1579050905060e0525b60605160e0518082811882841002189050905060e05260156040516020525f5260405f20546101005260e05160156040516020525f5260405f205560165460e0518082018281106128e15790509050610100518082038281116128e1579050905061012052610120516016556040517f7ecd84343f76a23d2227290e0288da3251b045541698e575a5515af4f04197a3606051610140526080516101605260e05161018052610120516101a0526080610140a2565b6102e051604052612788611cc4565b61030051604052612797611cc4565b61032051156128a8576002546103405260105415156103605261036051156127d5576102e051604052610340516060526040366080376127d56121f9565b60016102e0516020525f5260405f2054610320518082038281116128e15790509050610380526103805160016102e0516020525f5260405f20556102e051604052610380516060526103405160805261282c6125c3565b61036051156128515761030051604052610340516060526040366080376128516121f9565b6001610300516020525f5260405f2054610320518082018281106128e1579050905061038052610380516001610300516020525f5260405f20556103005160405261038051606052610340516080526128a86125c3565b610300516102e0517fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef61032051610340526020610340a3565b5f80fd047203f31c2d02c91c2d1c2d1c2d08ec1493082f07f01c2d0b6c0c441c2d0fe81b7311ec1c2d13bc1c2d04d3145a129d07941c2d1c2d0f061c2d0131072a1c2d1c2d1c2d1c2d1c2d185e0bee06ea15491c2d0b1c1c2d1c2d1c2d158a1c2d1c2d1c2d00b7088e001819b505150d6319441c2d070a084f0f861c2d0afc023f1c2d841929658118801880a16576797065728300030a0016");
        assert_eq!(
            Some(expected_contract),
            from_runtime_code(code),
            "length encoded as 2 bytes"
        );
    }

    #[test]
    fn from_creation_code_success() {
        // A basic check with not very long bytecode
        let code = from_hex("61009d3d81600a3d39f3fe71003461002457602061009a5f395f5160015560015f5561005f61002860003961005f6000f35b5f80fd5f3560e01c60026001821660011b61005b01601e395f51565b63158ef93e81186100535734610057575f5460405260206040f3610053565b633fa4f245811861005357346100575760015460405260206040f35b5f5ffd5b5f80fd0018003784185f810400a16576797065728300030a0013");
        let expected_contract = to_expected_contract(0, None, "3461002457602061009a5f395f5160015560015f5561005f61002860003961005f6000f35b5f80fd5f3560e01c60026001821660011b61005b01601e395f51565b63158ef93e81186100535734610057575f5460405260206040f3610053565b633fa4f245811861005357346100575760015460405260206040f35b5f5ffd5b5f80fd0018003784185f810400a16576797065728300030a0013");
        assert_eq!(
            Some(expected_contract),
            from_creation_code(code),
            "length encoded as 1 byte"
        );

        // A bytecode with length encoded as more than 1 byte
        let code = from_hex("612cdc3d81600a3d39f3fe71006129c551503461035a576020612cd95f395f518060a01c61035a57604052604051600d5533600b5532600c556040516395d89b4160a052606060a0600460bc845afa61004d573d5f5f3e3d5ffd5b60403d1061035a5760a05160a001602081511161035a5780516101205260208101516101405250610120905080516060526020810151608052505f6009610100527f43757276652e666920000000000000000000000000000000000000000000000061012052610100805160208201836101a00181518152505080830192505050606051816101a001608051815250808201915050600e610140527f204761756765204465706f73697400000000000000000000000000000000000061016052610140805160208201836101a001815181525050808301925050508061018052610180905060208151018060a0828460045afa505050602060a051015f81601f0160051c6003811161035a57801561017957905b8060051b60a001518160040155600101818118610161575b5050505f60605181610160016080518152508082019150506006610100527f2d67617567650000000000000000000000000000000000000000000000000000610120526101008051602082018361016001815181525050808301925050508061014052610140905060208151015f81601f0160051c6003811161035a57801561021557905b8060051b84015181600701556001018181186101fe575b505050504260235563b26b238e610100526020610100600461011c5f73d533a949740bb3306d119cc777fa900ba034cd525af1610254573d5f5f3e3d5ffd5b60203d1061035a576101005160d81b632c4e722e610140526020610140600461015c73d533a949740bb3306d119cc777fa900ba034cd525afa610299573d5f5f3e3d5ffd5b60203d1061035a576101405180820182811061035a5790509050600f5560a05160c0206129655260014303406129a55246612985527f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f6101205261296551610140527f71916ddf3efd1d13d14899519c9cd193fa3f9be07ea852717d2f225de1eb2466610160524661018052306101a0526129a5516101c05260c0610100526101008051602082012090506129c55261296561035e610000396129e5610000f35b5f80fd5f3560e01c6002603f821660011b6128e501601e395f51565b63bfa0b133811861003657346128e15760206129a560403960206040f35b63095ea7b38118611c2d576044361034176128e1576004358060a01c6128e1576040526024356003336020525f5260405f20806040516020525f5260405f20905055604051337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560243560605260206060a3600160605260206060f3611c2d565b6370a0823181186100f2576024361034176128e1576004358060a01c6128e15760405260016040516020525f5260405f205460605260206060f35b6301ddabf18118611c2d576024361034176128e1576004358060a01c6128e15760405260126040516020525f5260405f205460605260206060f3611c2d565b6318160ddd811861014d57346128e15760025460405260206040f35b6323b872dd8118611c2d576064361034176128e1576004358060a01c6128e1576103a0526024358060a01c6128e1576103c0525f546002146128e15760025f5560036103a0516020525f5260405f2080336020525f5260405f209050546103e0527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6103e0511461020b576103e0516044358082038281116128e1579050905060036103a0516020525f5260405f2080336020525f5260405f209050555b6103a0516102e0526103c051610300526044356103205261022a612779565b600161040052602061040060035f55f3611c2d565b63dd62ed3e8118610297576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260036040516020525f5260405f20806060516020525f5260405f2090505460805260206080f35b6384e9bd7e8118611c2d576024361034176128e1576004358060a01c6128e1576102e0525f61030052610f3a56611c2d565b6306fdde03811861034457346128e157602080604052806040016020600454015f81601f0160051c600381116128e157801561031857905b80600401548160051b850152600101818118610301575b5050508051806020830101601f825f03163682375050601f19601f825160200101169050810190506040f35b63331345838118611c2d576024361034176128e1576004358060a01c6128e1576102805261028051604052610377611cc4565b6019610280516020525f5260405f2054638b752bb06102a052610280516102c052306102e05260206102a060446102bc73d061d61a4d941c39e5453435b6345dc261c2fce05afa6103ca573d5f5f3e3d5ffd5b60203d106128e1576102a0518082038281116128e15790509050610300526020610300f3611c2d565b6395d89b418118611c2d57346128e157602080604052806040016020600754015f81601f0160051c600381116128e157801561044257905b80600701548160051b85015260010181811861042b575b5050508051806020830101601f825f03163682375050601f19601f825160200101169050810190506040f3611c2d565b637ecebe0081146003361116156104b3576024361034176128e1576004358060a01c6128e157604052600a6040516020525f5260405f205460605260206060f35b639c868ac08118611c2d57346128e157600e5460405260206040f3611c2d565b63c45a015581186104ef57346128e157600b5460405260206040f35b633644e5158118611c2d57346128e157602061050c610120611c31565b610120f3611c2d565b63481c6a75811861053157346128e157600c5460405260206040f35b6396c551758118611c2d576024361034176128e1576004358060a01c6128e157610280526018610280516020525f5260405f20546102a05263da020a1861032052610280516103405263010ae7576102e052610280516103005260206102e060246102fc735f3b5dfeb7b28cdbd7faba78963ee202a494e2a25afa6105b8573d5f5f3e3d5ffd5b60203d106128e1576102e051610360526020610320604461033c735f3b5dfeb7b28cdbd7faba78963ee202a494e2a25afa6105f5573d5f5f3e3d5ffd5b60203d106128e157610320516102c0526001610280516020525f5260405f20546102e0526370a082316103005261028051610320526020610300602461031c735f3b5dfeb7b28cdbd7faba78963ee202a494e2a25afa610657573d5f5f3e3d5ffd5b60203d106128e1576103005161066e576001610678565b6102a0516102c051115b156128e1576102e051602881028160288204186128e15790506064810490506015610280516020525f5260405f205411156128e157610280516040526106bc611cc4565b610280516040526001610280516020525f5260405f20546060526002546080526106e46125c3565b00611c2d565b6382c630668118611c2d57346128e157600d5460405260206040f3611c2d565b63963c94b98118611c2d57346128e15760105460405260206040f3611c2d565b6348e9c65e8118611c2d576024361034176128e1576004358060a01c6128e15760405260116040516020525f5260405f2080546060526001810154608052600281015460a052600381015460c052600481015460e0526005810154610100525060c06060f3611c2d565b63f05cc0588118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260136040516020525f5260405f20806060516020525f5260405f2090505460805260206080f3611c2d565b6313ecb1ca8118611c2d576024361034176128e1576004358060a01c6128e15760405260156040516020525f5260405f205460605260206060f3611c2d565b6317e280898118611c2d57346128e15760165460405260206040f3611c2d565b63de263bfa8118611c2d576024361034176128e1576004358060a01c6128e15760405260176040516020525f5260405f205460605260206060f3611c2d565b639bd324f281186108c9576024361034176128e1576004358060a01c6128e15760405260186040516020525f5260405f205460605260206060f35b63e6f1daf28118611c2d57346128e157336102e0525f61030052610f3a56611c2d565b63094007078118610927576024361034176128e1576004358060a01c6128e15760405260196040516020525f5260405f205460605260206060f35b6383df67478118611c2d576064361034176128e1576024358060a01c6128e1576102e0526044358060011c6128e157610300525b5f546002146128e15760025f556102e051156128e1576102e051604052610980611cc4565b60043515610af2576010541515610320526002546103405261032051156109c2576102e05160405261034051606052610300516080525f60a0526109c26121f9565b610340516004358082018281106128e157905090506103405260016102e0516020525f5260405f20546004358082018281106128e15790509050610360526103605160016102e0516020525f5260405f2055610340516002556102e0516040526103605160605261034051608052610a386125c3565b600d546323b872dd61038052336103a052306103c0526004356103e0526020610380606461039c5f855af1610a6f573d5f5f3e3d5ffd5b60203d106128e157610380518060011c6128e1576104005261040050506102e0517fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c600435610380526020610380a26102e0515f7fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef600435610380526020610380a35b60035f5500611c2d565b63ef78d4fd8118611c2d57346128e157601a5460405260206040f3611c2d565b6354c49fe98118610b49576024361034176128e157600435600781116128e157601b015460405260206040f35b63be5d1be98118611c2d57346128e157600f5460d81c60405260206040f3611c2d565b637598108c8118610ba5576024361034176128e1576004356c01431e0fae6d7217ca9fffffff81116128e1576023015460405260206040f35b63fec8ee0c8118611c2d576024361034176128e1576004356c01431e0fae6d7217ca9fffffff81116128e1576c01431e0fae6d7217caa0000023015460405260206040f3611c2d565b63b6b55f258118610c12576024361034176128e157336102e0525f6103005261095b565b636e553f658118611c2d576044361034176128e1576024358060a01c6128e1576102e0525f6103005261095b56611c2d565b632e1a7d4d8118610c63576024361034176128e1575f6102e052610d88565b63e8de0d4d8118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605233600c548118610ca5576001610ce8565b600b5463f851a44060e052602060e0600460fc845afa610cc7573d5f5f3e3d5ffd5b60203d106128e15760e0518060a01c6128e157610120526101209050518118155b9050156128e157606051156128e1576010546080526007608051116128e15760116040516020525f5260405f20600181019050546128e15760605160116040516020525f5260405f2060018101905055604051608051600781116128e157601b0155608051600181018181106128e157905060105500611c2d565b6338d074368118611c2d576044361034176128e1576024358060011c6128e1576102e0525b5f546002146128e15760025f5533604052610da1611cc4565b60043515610e9d57601054151561030052600254610320526103005115610de05733604052610320516060526102e0516080525f60a052610de06121f9565b610320516004358082038281116128e15790509050610320526001336020525f5260405f20546004358082038281116128e1579050905061034052610340516001336020525f5260405f205561032051600255336040526103405160605261032051608052610e4d6125c3565b600d5463a9059cbb6103605233610380526004356103a0526020610360604461037c5f855af1610e7f573d5f5f3e3d5ffd5b60203d106128e157610360518060011c6128e1576103c0526103c050505b337f884edad9ce6fa2440d8a54cc123490eb96d2768479d49ff9c7366125a9424364600435610300526020610300a25f337fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef600435610300526020610300a360035f5500611c2d565b639faceb1b8118611c2d576044361034176128e1576004358060a01c6128e1576102e0526024358060a01c6128e157610300525b5f546002146128e15760025f556103005115610f5b57336102e051186128e1575b6102e05160405260025460605260016080526103005160a052610f7c6121f9565b60035f5500611c2d565b63a9059cbb8118611c2d576044361034176128e1576004358060a01c6128e1576103a0525f546002146128e15760025f55336102e0526103a0516103005260243561032052610fd3612779565b60016103c05260206103c060035f55f3611c2d565b63d505accf8118611c2d5760e4361034176128e1576004358060a01c6128e157610120526024358060a01c6128e157610140526084358060081c6128e1576101605261012051156128e15760643542116128e157600a610120516020525f5260405f2054610180525f60026101c0527f19010000000000000000000000000000000000000000000000000000000000006101e0526101c08051602082018361032001815181525050808301925050506110a2610200611c31565b610200518161032001526020810190507f6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c961024052610120516102605261014051610280526044356102a052610180516102c0526064356102e05260c061022052610220805160208201209050816103200152602081019050806103005261030090508051602082012090506101a052610120515f610240526101a0516101c052610160516101e052604060a461020037602061024060806101c060015afa5061024051186128e1576044356003610120516020525f5260405f2080610140516020525f5260405f2090505560016101805101600a610120516020525f5260405f205561014051610120517f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9256044356101c05260206101c0a360016101c05260206101c0f3611c2d565b63395093518118611c2d576044361034176128e1576004358060a01c6128e1576040526003336020525f5260405f20806040516020525f5260405f209050546024358082018281106128e157905090506060526060516003336020525f5260405f20806040516020525f5260405f20905055604051337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560605160805260206080a3600160805260206080f3611c2d565b63a457c2d7811861134a576044361034176128e1576004358060a01c6128e1576040526003336020525f5260405f20806040516020525f5260405f209050546024358082038281116128e157905090506060526060516003336020525f5260405f20806040516020525f5260405f20905055604051337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560605160805260206080a3600160805260206080f35b6390b229978118611c2d576024361034176128e1576004358060011c6128e157604052600b5463f851a440606052602060606004607c845afa61138f573d5f5f3e3d5ffd5b60203d106128e1576060518060a01c6128e15760a05260a090505133186128e157604051600e5500611c2d565b634b8200938118611c2d576024361034176128e1576004358060a01c6128e15761028052336102805181186113f257600161140b565b73d061d61a4d941c39e5453435b6345dc261c2fce08118155b9050156128e15761028051604052611421611cc4565b610280516040526001610280516020525f5260405f20546060526002546080526114496125c3565b60016102a05260206102a0f3611c2d565b63bdf981168118611c2d576024361034176128e1576004358060a01c6128e1576040526040516012336020525f5260405f205500611c2d565b63aace1d488118611c2d576024361034176128e1576004358060a01c6128e15760405233600c5481186114c757600161150a565b600b5463f851a44060c052602060c0600460dc845afa6114e9573d5f5f3e3d5ffd5b60203d106128e15760c0518060a01c6128e157610100526101009050518118155b9050156128e157604051600c557fe83c80a0349150991cb09b4c940149ac4c37cb03673b6c0c669b4da27865c28b60405160605260206060a100611c2d565b6393f7aa67811861156b576044361034176128e15762093a80610300526115a7565b63313ce5678118611c2d57346128e157601260405260206040f3611c2d565b6333b50aed8118611826576064361034176128e157604435610300525b6004358060a01c6128e1576102e0525f546002146128e15760025f5560116102e0516020525f5260405f206001810190505433186128e1575f6040526002546060526040366080376115f76121f9565b6102e0516370a082316103405230610360526020610340602461035c845afa611622573d5f5f3e3d5ffd5b60203d106128e157610340905051610320526102e0516323b872dd61034052336103605230610380526024356103a0526020610340606461035c5f855af161166c573d5f5f3e3d5ffd5b3d61168357803b156128e15760016103c05261169c565b60203d106128e157610340518060011c6128e1576103c0525b6103c0905051156128e1576102e0516370a082316103405230610360526020610340602461035c845afa6116d2573d5f5f3e3d5ffd5b60203d106128e157610340905051610320518082038281116128e157905090506103205260116102e0516020525f5260405f206002810190505461034052610300516103205111156128e157610340514210156117b45761034051428082038281116128e15790509050610360526103605160116102e0516020525f5260405f20600381019050548082028115838383041417156128e157905090506103805261032051610380518082018281106128e157905090506103005180156128e1578082049050905060116102e0516020525f5260405f20600381019050556117e0565b610320516103005180156128e1578082049050905060116102e0516020525f5260405f20600381019050555b4260116102e0516020525f5260405f206004810190505542610300518082018281106128e1579050905060116102e0516020525f5260405f206002810190505560035f55005b63d31f3f6d8118611c2d57346128e157601a546c01431e0fae6d7217ca9fffffff81116128e1576023015460405260206040f3611c2d565b63058a3a248118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260116040516020525f5260405f20600181019050546080523360805181186118b857600161190f565b600b5463f851a440610100526020610100600461011c845afa6118dd573d5f5f3e3d5ffd5b60203d106128e157610100518060a01c6128e15761014052610140905051811861190857600161190f565b600c548118155b9050156128e157608051156128e157606051156128e15760605160116040516020525f5260405f206001810190505500611c2d565b63e77e74378118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260146040516020525f5260405f20806060516020525f5260405f209050546fffffffffffffffffffffffffffffffff8116905060805260206080f3611c2d565b6333fd6f748118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260116060516020525f5260405f206005810190505460805260025460a05260a05115611aca574260116060516020525f5260405f20600281019050548082811882841002189050905060c05260c05160116060516020525f5260405f20600481019050548082038281116128e1579050905060e05260805160e05160116060516020525f5260405f20600381019050548082028115838383041417156128e15790509050670de0b6b3a7640000810281670de0b6b3a76400008204186128e157905060a05180156128e157808204905090508082018281106128e157905090506080525b60136060516020525f5260405f20806040516020525f5260405f2090505460c05260016040516020525f5260405f205460805160c0518082038281116128e157905090508082028115838383041417156128e15790509050670de0b6b3a76400008104905060e05260146040516020525f5260405f20806060516020525f5260405f2090505460801c60e0518082018281106128e15790509050610100526020610100f3611c2d565b63180692d08118611baf57346128e157600f547affffffffffffffffffffffffffffffffffffffffffffffffffffff8116905060405260206040f35b6354fd4d508118611c2d57346128e15760208060805260066040527f76362e312e30000000000000000000000000000000000000000000000000000060605260408160800181518152602082015160208201528051806020830101601f825f03163682375050601f19601f8251602001011690509050810190506080f35b5f5ffd5b60206129855f395f514614611cb9577f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f60605260206129656080397f71916ddf3efd1d13d14899519c9cd193fa3f9be07ea852717d2f225de1eb246660a0524660c0523060e05260206129a56101003960c06040526040805160208201209050815250611cc2565b60206129c58239505b565b601a546060526060516c01431e0fae6d7217ca9fffffff81116128e157602301546080526060516c01431e0fae6d7217ca9fffffff81116128e1576c01431e0fae6d7217caa0000023015460a052600f5460c05260c05160d81c60e052600e546101005260c0517affffffffffffffffffffffffffffffffffffffffffffffffffffff811690506101205261012051610140526101005115611d6857604036610120375b60805160e05110611e265763b26b238e610180526020610180600461019c5f73d533a949740bb3306d119cc777fa900ba034cd525af1611daa573d5f5f3e3d5ffd5b60203d106128e157610180516101605261010051611e0957632c4e722e610180526020610180600461019c73d533a949740bb3306d119cc777fa900ba034cd525afa611df8573d5f5f3e3d5ffd5b60203d106128e15761018051610140525b6101605160d81b610140518082018281106128e15790509050600f555b6080514211156120fa576016546101605263615e523761018052306101a052732f50d538606fa9edd2b11e2446beb18c9d5846bb3b156128e1575f610180602461019c5f732f50d538606fa9edd2b11e2446beb18c9d5846bb5af1611e8d573d5f5f3e3d5ffd5b6080516101805260805162093a8081018181106128e157905062093a808104905062093a8081028162093a808204186128e157905042808281188284100218905090506101a0525f6101f4905b806101c0526101a051610180518082038281116128e157905090506101e05263d3078c9461022052306102405261018051610260526020610220604461023c732f50d538606fa9edd2b11e2446beb18c9d5846bb5afa611f3c573d5f5f3e3d5ffd5b60203d106128e157610220516102005261016051156120b0576101805160e0511015611f68575f611f71565b6101a05160e051105b611fd35760a05161012051610200518082028115838383041417156128e157905090506101e0518082028115838383041417156128e157905090506101605180156128e157808204905090508082018281106128e1579050905060a0526120b0565b60a05161012051610200518082028115838383041417156128e1579050905060e051610180518082038281116128e157905090508082028115838383041417156128e157905090506101605180156128e157808204905090508082018281106128e1579050905060a052610140516101205260a05161012051610200518082028115838383041417156128e157905090506101a05160e0518082038281116128e157905090508082028115838383041417156128e157905090506101605180156128e157808204905090508082018281106128e1579050905060a0525b426101a051186120bf576120f7565b6101a051610180526101a05162093a8081018181106128e157905042808281188284100218905090506101a052600101818118611eda575b50505b6060516001810180600f0b81186128e1579050606052606051601a55426060516c01431e0fae6d7217ca9fffffff81116128e1576023015560a0516060516c01431e0fae6d7217ca9fffffff81116128e1576c01431e0fae6d7217caa0000023015560156040516020525f5260405f20546101605260196040516020525f5260405f2080546101605160a05160176040516020525f5260405f20548082038281116128e157905090508082028115838383041417156128e15790509050670de0b6b3a7640000810490508082018281106128e1579050905081555060a05160176040516020525f5260405f20554260186040516020525f5260405f2055565b5f60c05260a05160e052604051156122545760016040516020525f5260405f205460c05260805161222a575f61222f565b60a051155b156122545760126040516020525f5260405f205460e05260e0516122545760405160e0525b601054610100525f6008905b8061012052610100516101205118612277576125bf565b61012051600781116128e157601b0154610140526011610140516020525f5260405f206005810190505461016052426011610140516020525f5260405f20600281019050548082811882841002189050905061018052610180516011610140516020525f5260405f20600481019050548082038281116128e157905090506101a0526101a0511561230c57606051151561230e565b5f5b156123ba57610180516011610140516020525f5260405f2060048101905055610160516101a0516011610140516020525f5260405f20600381019050548082028115838383041417156128e15790509050670de0b6b3a7640000810281670de0b6b3a76400008204186128e157905060605180156128e157808204905090508082018281106128e1579050905061016052610160516011610140516020525f5260405f20600581019050555b604051156125b4576013610140516020525f5260405f20806040516020525f5260405f209050546101c0525f6101e052610160516101c051101561245a57610160516013610140516020525f5260405f20806040516020525f5260405f2090505560c051610160516101c0518082038281116128e157905090508082028115838383041417156128e15790509050670de0b6b3a7640000810490506101e0525b60146040516020525f5260405f2080610140516020525f5260405f20905054610200526102005160801c6101e0518082018281106128e157905090506102205261022051156125b457610200516fffffffffffffffffffffffffffffffff811690506102405260805161250d576101e051156125b457610240516102205160801b8082018281106128e1579050905060146040516020525f5260405f2080610140516020525f5260405f209050556125b4565b6101405163a9059cbb6102605260e05161028052610220516102a0526020610260604461027c5f855af1612543573d5f5f3e3d5ffd5b3d61255a57803b156128e15760016102c052612573565b60203d106128e157610260518060011c6128e1576102c0525b6102c0905051156128e15761024051610220518082018281106128e1579050905060146040516020525f5260405f2080610140516020525f5260405f209050555b600101818118612260575b5050565b63bbf7408a60c05260405160e052602060c0602460dc738e0c00ed546602fd9927df742bbabf726d5b0d165afa6125fc573d5f5f3e3d5ffd5b60203d106128e15760c05160a0526318160ddd60e052602060e0600460fc735f3b5dfeb7b28cdbd7faba78963ee202a494e2a25afa61263d573d5f5f3e3d5ffd5b60203d106128e15760e05160c052606051602881028160288204186128e157905060648104905060e05260c051156126c45760e05160805160a0518082028115838383041417156128e1579050905060c05180156128e15780820490509050603c810281603c8204186128e15790506064810490508082018281106128e1579050905060e0525b60605160e0518082811882841002189050905060e05260156040516020525f5260405f20546101005260e05160156040516020525f5260405f205560165460e0518082018281106128e15790509050610100518082038281116128e1579050905061012052610120516016556040517f7ecd84343f76a23d2227290e0288da3251b045541698e575a5515af4f04197a3606051610140526080516101605260e05161018052610120516101a0526080610140a2565b6102e051604052612788611cc4565b61030051604052612797611cc4565b61032051156128a8576002546103405260105415156103605261036051156127d5576102e051604052610340516060526040366080376127d56121f9565b60016102e0516020525f5260405f2054610320518082038281116128e15790509050610380526103805160016102e0516020525f5260405f20556102e051604052610380516060526103405160805261282c6125c3565b61036051156128515761030051604052610340516060526040366080376128516121f9565b6001610300516020525f5260405f2054610320518082018281106128e1579050905061038052610380516001610300516020525f5260405f20556103005160405261038051606052610340516080526128a86125c3565b610300516102e0517fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef61032051610340526020610340a3565b5f80fd047203f31c2d02c91c2d1c2d1c2d08ec1493082f07f01c2d0b6c0c441c2d0fe81b7311ec1c2d13bc1c2d04d3145a129d07941c2d1c2d0f061c2d0131072a1c2d1c2d1c2d1c2d1c2d185e0bee06ea15491c2d0b1c1c2d1c2d1c2d158a1c2d1c2d1c2d00b7088e001819b505150d6319441c2d070a084f0f861c2d0afc023f1c2d841929658118801880a16576797065728300030a0016");
        let expected_contract = to_expected_contract(0, None, "6129c551503461035a576020612cd95f395f518060a01c61035a57604052604051600d5533600b5532600c556040516395d89b4160a052606060a0600460bc845afa61004d573d5f5f3e3d5ffd5b60403d1061035a5760a05160a001602081511161035a5780516101205260208101516101405250610120905080516060526020810151608052505f6009610100527f43757276652e666920000000000000000000000000000000000000000000000061012052610100805160208201836101a00181518152505080830192505050606051816101a001608051815250808201915050600e610140527f204761756765204465706f73697400000000000000000000000000000000000061016052610140805160208201836101a001815181525050808301925050508061018052610180905060208151018060a0828460045afa505050602060a051015f81601f0160051c6003811161035a57801561017957905b8060051b60a001518160040155600101818118610161575b5050505f60605181610160016080518152508082019150506006610100527f2d67617567650000000000000000000000000000000000000000000000000000610120526101008051602082018361016001815181525050808301925050508061014052610140905060208151015f81601f0160051c6003811161035a57801561021557905b8060051b84015181600701556001018181186101fe575b505050504260235563b26b238e610100526020610100600461011c5f73d533a949740bb3306d119cc777fa900ba034cd525af1610254573d5f5f3e3d5ffd5b60203d1061035a576101005160d81b632c4e722e610140526020610140600461015c73d533a949740bb3306d119cc777fa900ba034cd525afa610299573d5f5f3e3d5ffd5b60203d1061035a576101405180820182811061035a5790509050600f5560a05160c0206129655260014303406129a55246612985527f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f6101205261296551610140527f71916ddf3efd1d13d14899519c9cd193fa3f9be07ea852717d2f225de1eb2466610160524661018052306101a0526129a5516101c05260c0610100526101008051602082012090506129c55261296561035e610000396129e5610000f35b5f80fd5f3560e01c6002603f821660011b6128e501601e395f51565b63bfa0b133811861003657346128e15760206129a560403960206040f35b63095ea7b38118611c2d576044361034176128e1576004358060a01c6128e1576040526024356003336020525f5260405f20806040516020525f5260405f20905055604051337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560243560605260206060a3600160605260206060f3611c2d565b6370a0823181186100f2576024361034176128e1576004358060a01c6128e15760405260016040516020525f5260405f205460605260206060f35b6301ddabf18118611c2d576024361034176128e1576004358060a01c6128e15760405260126040516020525f5260405f205460605260206060f3611c2d565b6318160ddd811861014d57346128e15760025460405260206040f35b6323b872dd8118611c2d576064361034176128e1576004358060a01c6128e1576103a0526024358060a01c6128e1576103c0525f546002146128e15760025f5560036103a0516020525f5260405f2080336020525f5260405f209050546103e0527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6103e0511461020b576103e0516044358082038281116128e1579050905060036103a0516020525f5260405f2080336020525f5260405f209050555b6103a0516102e0526103c051610300526044356103205261022a612779565b600161040052602061040060035f55f3611c2d565b63dd62ed3e8118610297576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260036040516020525f5260405f20806060516020525f5260405f2090505460805260206080f35b6384e9bd7e8118611c2d576024361034176128e1576004358060a01c6128e1576102e0525f61030052610f3a56611c2d565b6306fdde03811861034457346128e157602080604052806040016020600454015f81601f0160051c600381116128e157801561031857905b80600401548160051b850152600101818118610301575b5050508051806020830101601f825f03163682375050601f19601f825160200101169050810190506040f35b63331345838118611c2d576024361034176128e1576004358060a01c6128e1576102805261028051604052610377611cc4565b6019610280516020525f5260405f2054638b752bb06102a052610280516102c052306102e05260206102a060446102bc73d061d61a4d941c39e5453435b6345dc261c2fce05afa6103ca573d5f5f3e3d5ffd5b60203d106128e1576102a0518082038281116128e15790509050610300526020610300f3611c2d565b6395d89b418118611c2d57346128e157602080604052806040016020600754015f81601f0160051c600381116128e157801561044257905b80600701548160051b85015260010181811861042b575b5050508051806020830101601f825f03163682375050601f19601f825160200101169050810190506040f3611c2d565b637ecebe0081146003361116156104b3576024361034176128e1576004358060a01c6128e157604052600a6040516020525f5260405f205460605260206060f35b639c868ac08118611c2d57346128e157600e5460405260206040f3611c2d565b63c45a015581186104ef57346128e157600b5460405260206040f35b633644e5158118611c2d57346128e157602061050c610120611c31565b610120f3611c2d565b63481c6a75811861053157346128e157600c5460405260206040f35b6396c551758118611c2d576024361034176128e1576004358060a01c6128e157610280526018610280516020525f5260405f20546102a05263da020a1861032052610280516103405263010ae7576102e052610280516103005260206102e060246102fc735f3b5dfeb7b28cdbd7faba78963ee202a494e2a25afa6105b8573d5f5f3e3d5ffd5b60203d106128e1576102e051610360526020610320604461033c735f3b5dfeb7b28cdbd7faba78963ee202a494e2a25afa6105f5573d5f5f3e3d5ffd5b60203d106128e157610320516102c0526001610280516020525f5260405f20546102e0526370a082316103005261028051610320526020610300602461031c735f3b5dfeb7b28cdbd7faba78963ee202a494e2a25afa610657573d5f5f3e3d5ffd5b60203d106128e1576103005161066e576001610678565b6102a0516102c051115b156128e1576102e051602881028160288204186128e15790506064810490506015610280516020525f5260405f205411156128e157610280516040526106bc611cc4565b610280516040526001610280516020525f5260405f20546060526002546080526106e46125c3565b00611c2d565b6382c630668118611c2d57346128e157600d5460405260206040f3611c2d565b63963c94b98118611c2d57346128e15760105460405260206040f3611c2d565b6348e9c65e8118611c2d576024361034176128e1576004358060a01c6128e15760405260116040516020525f5260405f2080546060526001810154608052600281015460a052600381015460c052600481015460e0526005810154610100525060c06060f3611c2d565b63f05cc0588118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260136040516020525f5260405f20806060516020525f5260405f2090505460805260206080f3611c2d565b6313ecb1ca8118611c2d576024361034176128e1576004358060a01c6128e15760405260156040516020525f5260405f205460605260206060f3611c2d565b6317e280898118611c2d57346128e15760165460405260206040f3611c2d565b63de263bfa8118611c2d576024361034176128e1576004358060a01c6128e15760405260176040516020525f5260405f205460605260206060f3611c2d565b639bd324f281186108c9576024361034176128e1576004358060a01c6128e15760405260186040516020525f5260405f205460605260206060f35b63e6f1daf28118611c2d57346128e157336102e0525f61030052610f3a56611c2d565b63094007078118610927576024361034176128e1576004358060a01c6128e15760405260196040516020525f5260405f205460605260206060f35b6383df67478118611c2d576064361034176128e1576024358060a01c6128e1576102e0526044358060011c6128e157610300525b5f546002146128e15760025f556102e051156128e1576102e051604052610980611cc4565b60043515610af2576010541515610320526002546103405261032051156109c2576102e05160405261034051606052610300516080525f60a0526109c26121f9565b610340516004358082018281106128e157905090506103405260016102e0516020525f5260405f20546004358082018281106128e15790509050610360526103605160016102e0516020525f5260405f2055610340516002556102e0516040526103605160605261034051608052610a386125c3565b600d546323b872dd61038052336103a052306103c0526004356103e0526020610380606461039c5f855af1610a6f573d5f5f3e3d5ffd5b60203d106128e157610380518060011c6128e1576104005261040050506102e0517fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c600435610380526020610380a26102e0515f7fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef600435610380526020610380a35b60035f5500611c2d565b63ef78d4fd8118611c2d57346128e157601a5460405260206040f3611c2d565b6354c49fe98118610b49576024361034176128e157600435600781116128e157601b015460405260206040f35b63be5d1be98118611c2d57346128e157600f5460d81c60405260206040f3611c2d565b637598108c8118610ba5576024361034176128e1576004356c01431e0fae6d7217ca9fffffff81116128e1576023015460405260206040f35b63fec8ee0c8118611c2d576024361034176128e1576004356c01431e0fae6d7217ca9fffffff81116128e1576c01431e0fae6d7217caa0000023015460405260206040f3611c2d565b63b6b55f258118610c12576024361034176128e157336102e0525f6103005261095b565b636e553f658118611c2d576044361034176128e1576024358060a01c6128e1576102e0525f6103005261095b56611c2d565b632e1a7d4d8118610c63576024361034176128e1575f6102e052610d88565b63e8de0d4d8118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605233600c548118610ca5576001610ce8565b600b5463f851a44060e052602060e0600460fc845afa610cc7573d5f5f3e3d5ffd5b60203d106128e15760e0518060a01c6128e157610120526101209050518118155b9050156128e157606051156128e1576010546080526007608051116128e15760116040516020525f5260405f20600181019050546128e15760605160116040516020525f5260405f2060018101905055604051608051600781116128e157601b0155608051600181018181106128e157905060105500611c2d565b6338d074368118611c2d576044361034176128e1576024358060011c6128e1576102e0525b5f546002146128e15760025f5533604052610da1611cc4565b60043515610e9d57601054151561030052600254610320526103005115610de05733604052610320516060526102e0516080525f60a052610de06121f9565b610320516004358082038281116128e15790509050610320526001336020525f5260405f20546004358082038281116128e1579050905061034052610340516001336020525f5260405f205561032051600255336040526103405160605261032051608052610e4d6125c3565b600d5463a9059cbb6103605233610380526004356103a0526020610360604461037c5f855af1610e7f573d5f5f3e3d5ffd5b60203d106128e157610360518060011c6128e1576103c0526103c050505b337f884edad9ce6fa2440d8a54cc123490eb96d2768479d49ff9c7366125a9424364600435610300526020610300a25f337fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef600435610300526020610300a360035f5500611c2d565b639faceb1b8118611c2d576044361034176128e1576004358060a01c6128e1576102e0526024358060a01c6128e157610300525b5f546002146128e15760025f556103005115610f5b57336102e051186128e1575b6102e05160405260025460605260016080526103005160a052610f7c6121f9565b60035f5500611c2d565b63a9059cbb8118611c2d576044361034176128e1576004358060a01c6128e1576103a0525f546002146128e15760025f55336102e0526103a0516103005260243561032052610fd3612779565b60016103c05260206103c060035f55f3611c2d565b63d505accf8118611c2d5760e4361034176128e1576004358060a01c6128e157610120526024358060a01c6128e157610140526084358060081c6128e1576101605261012051156128e15760643542116128e157600a610120516020525f5260405f2054610180525f60026101c0527f19010000000000000000000000000000000000000000000000000000000000006101e0526101c08051602082018361032001815181525050808301925050506110a2610200611c31565b610200518161032001526020810190507f6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c961024052610120516102605261014051610280526044356102a052610180516102c0526064356102e05260c061022052610220805160208201209050816103200152602081019050806103005261030090508051602082012090506101a052610120515f610240526101a0516101c052610160516101e052604060a461020037602061024060806101c060015afa5061024051186128e1576044356003610120516020525f5260405f2080610140516020525f5260405f2090505560016101805101600a610120516020525f5260405f205561014051610120517f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9256044356101c05260206101c0a360016101c05260206101c0f3611c2d565b63395093518118611c2d576044361034176128e1576004358060a01c6128e1576040526003336020525f5260405f20806040516020525f5260405f209050546024358082018281106128e157905090506060526060516003336020525f5260405f20806040516020525f5260405f20905055604051337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560605160805260206080a3600160805260206080f3611c2d565b63a457c2d7811861134a576044361034176128e1576004358060a01c6128e1576040526003336020525f5260405f20806040516020525f5260405f209050546024358082038281116128e157905090506060526060516003336020525f5260405f20806040516020525f5260405f20905055604051337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560605160805260206080a3600160805260206080f35b6390b229978118611c2d576024361034176128e1576004358060011c6128e157604052600b5463f851a440606052602060606004607c845afa61138f573d5f5f3e3d5ffd5b60203d106128e1576060518060a01c6128e15760a05260a090505133186128e157604051600e5500611c2d565b634b8200938118611c2d576024361034176128e1576004358060a01c6128e15761028052336102805181186113f257600161140b565b73d061d61a4d941c39e5453435b6345dc261c2fce08118155b9050156128e15761028051604052611421611cc4565b610280516040526001610280516020525f5260405f20546060526002546080526114496125c3565b60016102a05260206102a0f3611c2d565b63bdf981168118611c2d576024361034176128e1576004358060a01c6128e1576040526040516012336020525f5260405f205500611c2d565b63aace1d488118611c2d576024361034176128e1576004358060a01c6128e15760405233600c5481186114c757600161150a565b600b5463f851a44060c052602060c0600460dc845afa6114e9573d5f5f3e3d5ffd5b60203d106128e15760c0518060a01c6128e157610100526101009050518118155b9050156128e157604051600c557fe83c80a0349150991cb09b4c940149ac4c37cb03673b6c0c669b4da27865c28b60405160605260206060a100611c2d565b6393f7aa67811861156b576044361034176128e15762093a80610300526115a7565b63313ce5678118611c2d57346128e157601260405260206040f3611c2d565b6333b50aed8118611826576064361034176128e157604435610300525b6004358060a01c6128e1576102e0525f546002146128e15760025f5560116102e0516020525f5260405f206001810190505433186128e1575f6040526002546060526040366080376115f76121f9565b6102e0516370a082316103405230610360526020610340602461035c845afa611622573d5f5f3e3d5ffd5b60203d106128e157610340905051610320526102e0516323b872dd61034052336103605230610380526024356103a0526020610340606461035c5f855af161166c573d5f5f3e3d5ffd5b3d61168357803b156128e15760016103c05261169c565b60203d106128e157610340518060011c6128e1576103c0525b6103c0905051156128e1576102e0516370a082316103405230610360526020610340602461035c845afa6116d2573d5f5f3e3d5ffd5b60203d106128e157610340905051610320518082038281116128e157905090506103205260116102e0516020525f5260405f206002810190505461034052610300516103205111156128e157610340514210156117b45761034051428082038281116128e15790509050610360526103605160116102e0516020525f5260405f20600381019050548082028115838383041417156128e157905090506103805261032051610380518082018281106128e157905090506103005180156128e1578082049050905060116102e0516020525f5260405f20600381019050556117e0565b610320516103005180156128e1578082049050905060116102e0516020525f5260405f20600381019050555b4260116102e0516020525f5260405f206004810190505542610300518082018281106128e1579050905060116102e0516020525f5260405f206002810190505560035f55005b63d31f3f6d8118611c2d57346128e157601a546c01431e0fae6d7217ca9fffffff81116128e1576023015460405260206040f3611c2d565b63058a3a248118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260116040516020525f5260405f20600181019050546080523360805181186118b857600161190f565b600b5463f851a440610100526020610100600461011c845afa6118dd573d5f5f3e3d5ffd5b60203d106128e157610100518060a01c6128e15761014052610140905051811861190857600161190f565b600c548118155b9050156128e157608051156128e157606051156128e15760605160116040516020525f5260405f206001810190505500611c2d565b63e77e74378118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260146040516020525f5260405f20806060516020525f5260405f209050546fffffffffffffffffffffffffffffffff8116905060805260206080f3611c2d565b6333fd6f748118611c2d576044361034176128e1576004358060a01c6128e1576040526024358060a01c6128e15760605260116060516020525f5260405f206005810190505460805260025460a05260a05115611aca574260116060516020525f5260405f20600281019050548082811882841002189050905060c05260c05160116060516020525f5260405f20600481019050548082038281116128e1579050905060e05260805160e05160116060516020525f5260405f20600381019050548082028115838383041417156128e15790509050670de0b6b3a7640000810281670de0b6b3a76400008204186128e157905060a05180156128e157808204905090508082018281106128e157905090506080525b60136060516020525f5260405f20806040516020525f5260405f2090505460c05260016040516020525f5260405f205460805160c0518082038281116128e157905090508082028115838383041417156128e15790509050670de0b6b3a76400008104905060e05260146040516020525f5260405f20806060516020525f5260405f2090505460801c60e0518082018281106128e15790509050610100526020610100f3611c2d565b63180692d08118611baf57346128e157600f547affffffffffffffffffffffffffffffffffffffffffffffffffffff8116905060405260206040f35b6354fd4d508118611c2d57346128e15760208060805260066040527f76362e312e30000000000000000000000000000000000000000000000000000060605260408160800181518152602082015160208201528051806020830101601f825f03163682375050601f19601f8251602001011690509050810190506080f35b5f5ffd5b60206129855f395f514614611cb9577f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f60605260206129656080397f71916ddf3efd1d13d14899519c9cd193fa3f9be07ea852717d2f225de1eb246660a0524660c0523060e05260206129a56101003960c06040526040805160208201209050815250611cc2565b60206129c58239505b565b601a546060526060516c01431e0fae6d7217ca9fffffff81116128e157602301546080526060516c01431e0fae6d7217ca9fffffff81116128e1576c01431e0fae6d7217caa0000023015460a052600f5460c05260c05160d81c60e052600e546101005260c0517affffffffffffffffffffffffffffffffffffffffffffffffffffff811690506101205261012051610140526101005115611d6857604036610120375b60805160e05110611e265763b26b238e610180526020610180600461019c5f73d533a949740bb3306d119cc777fa900ba034cd525af1611daa573d5f5f3e3d5ffd5b60203d106128e157610180516101605261010051611e0957632c4e722e610180526020610180600461019c73d533a949740bb3306d119cc777fa900ba034cd525afa611df8573d5f5f3e3d5ffd5b60203d106128e15761018051610140525b6101605160d81b610140518082018281106128e15790509050600f555b6080514211156120fa576016546101605263615e523761018052306101a052732f50d538606fa9edd2b11e2446beb18c9d5846bb3b156128e1575f610180602461019c5f732f50d538606fa9edd2b11e2446beb18c9d5846bb5af1611e8d573d5f5f3e3d5ffd5b6080516101805260805162093a8081018181106128e157905062093a808104905062093a8081028162093a808204186128e157905042808281188284100218905090506101a0525f6101f4905b806101c0526101a051610180518082038281116128e157905090506101e05263d3078c9461022052306102405261018051610260526020610220604461023c732f50d538606fa9edd2b11e2446beb18c9d5846bb5afa611f3c573d5f5f3e3d5ffd5b60203d106128e157610220516102005261016051156120b0576101805160e0511015611f68575f611f71565b6101a05160e051105b611fd35760a05161012051610200518082028115838383041417156128e157905090506101e0518082028115838383041417156128e157905090506101605180156128e157808204905090508082018281106128e1579050905060a0526120b0565b60a05161012051610200518082028115838383041417156128e1579050905060e051610180518082038281116128e157905090508082028115838383041417156128e157905090506101605180156128e157808204905090508082018281106128e1579050905060a052610140516101205260a05161012051610200518082028115838383041417156128e157905090506101a05160e0518082038281116128e157905090508082028115838383041417156128e157905090506101605180156128e157808204905090508082018281106128e1579050905060a0525b426101a051186120bf576120f7565b6101a051610180526101a05162093a8081018181106128e157905042808281188284100218905090506101a052600101818118611eda575b50505b6060516001810180600f0b81186128e1579050606052606051601a55426060516c01431e0fae6d7217ca9fffffff81116128e1576023015560a0516060516c01431e0fae6d7217ca9fffffff81116128e1576c01431e0fae6d7217caa0000023015560156040516020525f5260405f20546101605260196040516020525f5260405f2080546101605160a05160176040516020525f5260405f20548082038281116128e157905090508082028115838383041417156128e15790509050670de0b6b3a7640000810490508082018281106128e1579050905081555060a05160176040516020525f5260405f20554260186040516020525f5260405f2055565b5f60c05260a05160e052604051156122545760016040516020525f5260405f205460c05260805161222a575f61222f565b60a051155b156122545760126040516020525f5260405f205460e05260e0516122545760405160e0525b601054610100525f6008905b8061012052610100516101205118612277576125bf565b61012051600781116128e157601b0154610140526011610140516020525f5260405f206005810190505461016052426011610140516020525f5260405f20600281019050548082811882841002189050905061018052610180516011610140516020525f5260405f20600481019050548082038281116128e157905090506101a0526101a0511561230c57606051151561230e565b5f5b156123ba57610180516011610140516020525f5260405f2060048101905055610160516101a0516011610140516020525f5260405f20600381019050548082028115838383041417156128e15790509050670de0b6b3a7640000810281670de0b6b3a76400008204186128e157905060605180156128e157808204905090508082018281106128e1579050905061016052610160516011610140516020525f5260405f20600581019050555b604051156125b4576013610140516020525f5260405f20806040516020525f5260405f209050546101c0525f6101e052610160516101c051101561245a57610160516013610140516020525f5260405f20806040516020525f5260405f2090505560c051610160516101c0518082038281116128e157905090508082028115838383041417156128e15790509050670de0b6b3a7640000810490506101e0525b60146040516020525f5260405f2080610140516020525f5260405f20905054610200526102005160801c6101e0518082018281106128e157905090506102205261022051156125b457610200516fffffffffffffffffffffffffffffffff811690506102405260805161250d576101e051156125b457610240516102205160801b8082018281106128e1579050905060146040516020525f5260405f2080610140516020525f5260405f209050556125b4565b6101405163a9059cbb6102605260e05161028052610220516102a0526020610260604461027c5f855af1612543573d5f5f3e3d5ffd5b3d61255a57803b156128e15760016102c052612573565b60203d106128e157610260518060011c6128e1576102c0525b6102c0905051156128e15761024051610220518082018281106128e1579050905060146040516020525f5260405f2080610140516020525f5260405f209050555b600101818118612260575b5050565b63bbf7408a60c05260405160e052602060c0602460dc738e0c00ed546602fd9927df742bbabf726d5b0d165afa6125fc573d5f5f3e3d5ffd5b60203d106128e15760c05160a0526318160ddd60e052602060e0600460fc735f3b5dfeb7b28cdbd7faba78963ee202a494e2a25afa61263d573d5f5f3e3d5ffd5b60203d106128e15760e05160c052606051602881028160288204186128e157905060648104905060e05260c051156126c45760e05160805160a0518082028115838383041417156128e1579050905060c05180156128e15780820490509050603c810281603c8204186128e15790506064810490508082018281106128e1579050905060e0525b60605160e0518082811882841002189050905060e05260156040516020525f5260405f20546101005260e05160156040516020525f5260405f205560165460e0518082018281106128e15790509050610100518082038281116128e1579050905061012052610120516016556040517f7ecd84343f76a23d2227290e0288da3251b045541698e575a5515af4f04197a3606051610140526080516101605260e05161018052610120516101a0526080610140a2565b6102e051604052612788611cc4565b61030051604052612797611cc4565b61032051156128a8576002546103405260105415156103605261036051156127d5576102e051604052610340516060526040366080376127d56121f9565b60016102e0516020525f5260405f2054610320518082038281116128e15790509050610380526103805160016102e0516020525f5260405f20556102e051604052610380516060526103405160805261282c6125c3565b61036051156128515761030051604052610340516060526040366080376128516121f9565b6001610300516020525f5260405f2054610320518082018281106128e1579050905061038052610380516001610300516020525f5260405f20556103005160405261038051606052610340516080526128a86125c3565b610300516102e0517fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef61032051610340526020610340a3565b5f80fd047203f31c2d02c91c2d1c2d1c2d08ec1493082f07f01c2d0b6c0c441c2d0fe81b7311ec1c2d13bc1c2d04d3145a129d07941c2d1c2d0f061c2d0131072a1c2d1c2d1c2d1c2d1c2d185e0bee06ea15491c2d0b1c1c2d1c2d1c2d158a1c2d1c2d1c2d00b7088e001819b505150d6319441c2d070a084f0f861c2d0afc023f1c2d841929658118801880a16576797065728300030a0016");
        assert_eq!(
            Some(expected_contract),
            from_creation_code(code),
            "length encoded as 2 bytes"
        );
    }

    #[test]
    fn code_without_blueprint_prefix_none() {
        let code = from_hex("3461002457602061009a5f395f5160015560015f5561005f61002860003961005f6000f35b5f80fd5f3560e01c60026001821660011b61005b01601e395f51565b63158ef93e81186100535734610057575f5460405260206040f3610053565b633fa4f245811861005357346100575760015460405260206040f35b5f5ffd5b5f80fd0018003784185f810400a16576797065728300030a0013");
        assert_eq!(None, from_runtime_code(code), "from_runtime_code");
    }

    #[test]
    fn empty_code_not_fails() {
        let code = Bytes::new();
        assert_eq!(
            None,
            from_creation_code(code.clone()),
            "empty creation code"
        );
        assert_eq!(None, from_runtime_code(code), "empty runtime code");
    }

    #[test]
    fn does_not_support_non_zero_version() {
        let code = from_hex("FE710400");
        assert_eq!(None, from_runtime_code(code),);
    }

    #[test]
    fn supports_data_field() {
        let code = from_hex(String::from_iter(["FE7101", "07", &"FF".repeat(7), "00"]).as_str());
        let expected_contract = to_expected_contract(0, Some("FF".repeat(7).as_str()), "00");
        assert_eq!(
            Some(expected_contract),
            from_runtime_code(code),
            "1 byte data length"
        );

        let code =
            from_hex(String::from_iter(["FE7102", "0100", &"FF".repeat(256), "00"]).as_str());
        let expected_contract = to_expected_contract(0, Some("FF".repeat(256).as_str()), "00");
        assert_eq!(
            Some(expected_contract),
            from_runtime_code(code),
            "2 bytes data length"
        );

        // 0b11 length is not supported by the standard
        let code =
            from_hex(String::from_iter(["FE7103", "010000", &"FF".repeat(65536), "00"]).as_str());
        assert_eq!(None, from_runtime_code(code), "3 bytes data length");
    }

    #[test]
    fn should_not_panic_if_initcode_is_absent() {
        let code = from_hex("FE7100");
        assert_eq!(None, from_runtime_code(code),)
    }
}
