CREATE TYPE "deployment_status_type" AS ENUM (
  'created',
  'pending',
  'running',
  'stopping',
  'stopped',
  'failed'
);

CREATE TABLE "users" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "email" varchar(255) NOT NULL,
  "project_title" varchar,
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP),
  "is_superuser" bool NOT NULL DEFAULT false,
  "balance" numeric NOT NULL DEFAULT 0
);

CREATE TABLE "auth_tokens" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "token_value" UUID NOT NULL DEFAULT (gen_random_uuid()),
  "user_id" int NOT NULL REFERENCES "users" ("id"),
  "deleted" bool NOT NULL DEFAULT false,
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP)
);

CREATE TABLE "user_actions" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "token_id" int NOT NULL REFERENCES "auth_tokens" ("id"),
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP),
  "action" varchar(255) NOT NULL,
  "data" jsonb NOT NULL DEFAULT '{}'
);

CREATE TABLE "instances" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "external_id" UUID UNIQUE DEFAULT (gen_random_uuid()),
  "creator_token_id" int NOT NULL REFERENCES "auth_tokens" ("id"),
  "slug" varchar(255) NOT NULL,
  "user_config" jsonb NOT NULL DEFAULT '{}',
  "parsed_config" jsonb NOT NULL DEFAULT '{}',
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP),
  "updated_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP)
);

CREATE TABLE "server_specs" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "slug" varchar(255) UNIQUE NOT NULL,
  "cost_per_hour" numeric NOT NULL,
  "resources_config" jsonb NOT NULL DEFAULT '{}'
);

CREATE TABLE "deployments" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "instance_id" int NOT NULL REFERENCES "instances" ("id"),
  "server_spec_id" int NOT NULL REFERENCES "server_specs" ("id"),
  "user_config" jsonb NOT NULL DEFAULT '{}',
  "parsed_config" jsonb NOT NULL DEFAULT '{}',
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP),
  "finished_at" timestamp,
  "status" deployment_status_type NOT NULL DEFAULT 'created',
  "error" varchar,
  "total_cost" numeric NOT NULL DEFAULT 0,
  CONSTRAINT "fk_instance_id" FOREIGN KEY ("instance_id") REFERENCES "instances" ("id"),
  CONSTRAINT "fk_server_spec_id" FOREIGN KEY ("server_spec_id") REFERENCES "server_specs" ("id")
);

CREATE TABLE "balance_changes" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "user_id" int NOT NULL REFERENCES "users" ("id"),
  "changed_by_user_id" int REFERENCES "users" ("id"),
  "amount" numeric NOT NULL,
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP),
  "note" varchar
);

CREATE TABLE "balance_expenses" (
  "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "user_id" int NOT NULL REFERENCES "users" ("id"),
  "deployment_id" int NOT NULL REFERENCES "deployments" ("id"),
  "expense_amount" numeric NOT NULL,
  "created_at" timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP)
);
